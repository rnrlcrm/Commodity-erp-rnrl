# Cloud Build Configuration for Cotton ERP
# Project: commodity-plafform-sandbox
# 
# Triggers on: Push to main/develop branches
# Builds: Backend + Frontend Docker images
# Deploys: Cloud Run services

steps:
  # ============================================================================
  # STEP 1: Build Backend Docker Image
  # ============================================================================
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-backend'
    args:
      - 'build'
      - '--no-cache'
      - '-t'
      - 'us-central1-docker.pkg.dev/$PROJECT_ID/cotton-erp/backend:$SHORT_SHA'
      - '-t'
      - 'us-central1-docker.pkg.dev/$PROJECT_ID/cotton-erp/backend:latest'
      - '-f'
      - 'infra/docker/backend/Dockerfile.prod'
      - '.'
    timeout: '900s'

  # ============================================================================
  # STEP 2: Push Backend Image to Artifact Registry
  # ============================================================================
  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-backend-latest'
    args:
      - 'push'
      - 'us-central1-docker.pkg.dev/$PROJECT_ID/cotton-erp/backend:latest'
    waitFor: ['build-backend']
  
  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-backend-sha'
    args:
      - 'push'
      - 'us-central1-docker.pkg.dev/$PROJECT_ID/cotton-erp/backend:$SHORT_SHA'
    waitFor: ['build-backend']

  # ============================================================================
  # STEP 3: Build Frontend Docker Image (includes build + Nginx)
  # ============================================================================
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-frontend-image'
    args:
      - 'build'
      - '-t'
      - 'us-central1-docker.pkg.dev/$PROJECT_ID/cotton-erp/frontend:$SHORT_SHA'
      - '-t'
      - 'us-central1-docker.pkg.dev/$PROJECT_ID/cotton-erp/frontend:latest'
      - '--build-arg'
      - 'VITE_API_URL=https://backend-service-565186585906.a.run.app'
      - '-f'
      - 'infra/docker/frontend/Dockerfile.prod'
      - 'frontend'
    waitFor: ['build-backend']
    timeout: '900s'

  # ============================================================================
  # STEP 4: Push Frontend Image
  # ============================================================================
  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-frontend-latest'
    args:
      - 'push'
      - 'us-central1-docker.pkg.dev/$PROJECT_ID/cotton-erp/frontend:latest'
    waitFor: ['build-frontend-image']
  
  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-frontend-sha'
    args:
      - 'push'
      - 'us-central1-docker.pkg.dev/$PROJECT_ID/cotton-erp/frontend:$SHORT_SHA'
    waitFor: ['build-frontend-image']

  # ============================================================================
  # STEP 5: Run Database Migrations (before deploying services)
  # Uses Cloud SQL Proxy via gcloud run jobs execute
  # ============================================================================
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'run-migrations'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        # Create a temporary Cloud Run Job to run migrations with Cloud SQL Proxy
        gcloud run jobs create migration-job-$BUILD_ID \
          --image=us-central1-docker.pkg.dev/$PROJECT_ID/cotton-erp/backend:$SHORT_SHA \
          --region=us-central1 \
          --set-env-vars=ENVIRONMENT=sandbox \
          --set-secrets=DATABASE_URL=database-url:latest \
          --set-cloudsql-instances=commodity-plafform-sandbox:us-central1:cotton-erp-db \
          --vpc-connector=cotton-erp-connector \
          --service-account=backend-runtime@$PROJECT_ID.iam.gserviceaccount.com \
          --args="sh,-c,cd backend && alembic upgrade head"
        
        # Execute the job and wait for completion
        gcloud run jobs execute migration-job-$BUILD_ID --region=us-central1 --wait || exit 1
        
        # Delete the job after successful execution
        gcloud run jobs delete migration-job-$BUILD_ID --region=us-central1 --quiet || true
    waitFor: ['push-backend-sha']
    timeout: '600s'

  # ============================================================================
  # STEP 6: Deploy Backend to Cloud Run
  # ============================================================================
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-backend'
    entrypoint: 'gcloud'
    args:
      - 'run'
      - 'deploy'
      - 'backend-service'
      - '--image=us-central1-docker.pkg.dev/$PROJECT_ID/cotton-erp/backend:$SHORT_SHA'
      - '--region=us-central1'
      - '--platform=managed'
      - '--allow-unauthenticated'
      - '--min-instances=0'
      - '--max-instances=3'
      - '--cpu=2'
      - '--memory=4Gi'
      - '--timeout=300'
      - '--concurrency=80'
      - '--port=8000'
      - '--vpc-connector=cotton-erp-connector'
      - '--set-env-vars=ENVIRONMENT=sandbox,LOG_LEVEL=INFO,GCP_PROJECT_ID=$PROJECT_ID'
      - '--set-secrets=DATABASE_URL=database-url:latest,REDIS_URL=redis-url:latest,JWT_SECRET_KEY=jwt-secret:latest,OPENAI_API_KEY=openai-key:latest'
      - '--service-account=backend-runtime@$PROJECT_ID.iam.gserviceaccount.com'
      - '--startup-cpu-boost'
      - '--no-cpu-throttling'
    waitFor: ['run-migrations']
    timeout: '600s'

  # ============================================================================
  # STEP 7: Deploy Frontend to Cloud Run
  # ============================================================================
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-frontend'
    entrypoint: 'gcloud'
    args:
      - 'run'
      - 'deploy'
      - 'frontend-service'
      - '--image=us-central1-docker.pkg.dev/$PROJECT_ID/cotton-erp/frontend:$SHORT_SHA'
      - '--region=us-central1'
      - '--platform=managed'
      - '--allow-unauthenticated'
      - '--min-instances=0'
      - '--max-instances=2'
      - '--cpu=1'
      - '--memory=512Mi'
      - '--port=80'
    waitFor: ['push-frontend-sha', 'push-frontend-latest']
    timeout: '300s'

  # ============================================================================
  # STEP 8: Health Check
  # ============================================================================
  - name: 'gcr.io/cloud-builders/curl'
    id: 'health-check'
    entrypoint: 'sh'
    args:
      - '-c'
      - |
        BACKEND_URL=$$(gcloud run services describe backend-service --region=us-central1 --format='value(status.url)')
        echo "Testing backend at: $$BACKEND_URL/health"
        curl -f "$$BACKEND_URL/health" || exit 1
        echo "âœ… Backend health check passed"
    waitFor: ['deploy-backend']

# Build options
options:
  machineType: 'E2_HIGHCPU_8'
  logging: CLOUD_LOGGING_ONLY
  dynamicSubstitutions: true

# Timeout for entire build
timeout: 1800s

# Images to store in Artifact Registry
images:
  - 'us-central1-docker.pkg.dev/$PROJECT_ID/cotton-erp/backend:$SHORT_SHA'
  - 'us-central1-docker.pkg.dev/$PROJECT_ID/cotton-erp/backend:latest'
  - 'us-central1-docker.pkg.dev/$PROJECT_ID/cotton-erp/frontend:$SHORT_SHA'
  - 'us-central1-docker.pkg.dev/$PROJECT_ID/cotton-erp/frontend:latest'
# Cloud Build needs secretmanager.secretAccessor role
