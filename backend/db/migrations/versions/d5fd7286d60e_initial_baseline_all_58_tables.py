"""Initial baseline - All 58 tables

Revision ID: d5fd7286d60e
Revises: 
Create Date: 2025-12-08 14:42:01.272180

"""
from __future__ import annotations

from alembic import op
import sqlalchemy as sa

from sqlalchemy.dialects import postgresql
import pgvector.sqlalchemy  # Vector column type for embeddings

# revision identifiers, used by Alembic.
revision = 'd5fd7286d60e'
down_revision = None
branch_labels = None
depends_on = None


def upgrade() -> None:
    # NOTE: pgvector extension is created in infra/docker/postgres/init.sql
    # For production Cloud SQL, enable via: gcloud sql instances patch INSTANCE --database-flags=cloudsql.enable_pgvector=on
    
    # ENUM types are auto-created by SQLAlchemy when first table using them is created
    # They are auto-dropped in downgrade() function at the end
    
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('bargain_types',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('name', sa.String(length=100), nullable=False),
    sa.Column('code', sa.String(length=20), nullable=True),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('requires_approval', sa.Boolean(), nullable=False),
    sa.Column('is_active', sa.Boolean(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('NOW()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('code'),
    sa.UniqueConstraint('name')
    )
    op.create_table('business_partners',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('partner_code', sa.String(length=50), nullable=True, comment='Auto-generated: BP-IND-SEL-0001'),
    sa.Column('service_provider_type', sa.String(length=50), nullable=True, comment='For service providers: broker, sub_broker, transporter, controller, financer, shipping_agent'),
    sa.Column('legal_name', sa.String(length=500), nullable=False),
    sa.Column('trade_name', sa.String(length=500), nullable=True),
    sa.Column('country', sa.String(length=100), nullable=False),
    sa.Column('business_entity_type', sa.String(length=100), nullable=True, comment='proprietorship, partnership, llp, private_limited, public_limited, corporation'),
    sa.Column('registration_date', sa.Date(), nullable=True, comment='From tax registration'),
    sa.Column('entity_class', sa.String(length=20), nullable=True, comment='business_entity (can trade) OR service_provider (cannot trade)'),
    sa.Column('capabilities', postgresql.JSON(astext_type=sa.Text()), server_default=sa.text("'{}'::json"), nullable=True, comment='Auto-detected from verified documents:\n        {\n            "domestic_buy_india": bool,\n            "domestic_sell_india": bool,\n            "domestic_buy_home_country": bool,\n            "domestic_sell_home_country": bool,\n            "import_allowed": bool,\n            "export_allowed": bool,\n            "auto_detected": bool,\n            "detected_from_documents": ["GST", "PAN", "IEC", ...],\n            "detected_at": "ISO timestamp",\n            "manual_override": bool,\n            "override_reason": str | null\n        }\n        CRITICAL: Foreign entities can ONLY trade in home country (domestic_buy_india=false, domestic_sell_india=false)\n        '),
    sa.Column('master_entity_id', sa.UUID(), nullable=True, comment='If this is a branch/subsidiary, points to master entity'),
    sa.Column('is_master_entity', sa.Boolean(), nullable=False, comment='True if this entity has branches/subsidiaries'),
    sa.Column('corporate_group_id', sa.UUID(), nullable=True, comment='Entities in same group cannot trade with each other (insider trading prevention)'),
    sa.Column('entity_hierarchy', postgresql.JSON(astext_type=sa.Text()), nullable=True, comment='Full entity hierarchy for compliance:\n        {\n            "ultimate_parent": "Company XYZ Ltd",\n            "parent_chain": ["Parent Corp", "Subsidiary A"],\n            "ownership_percentage": 75.5,\n            "group_structure": "vertical" | "horizontal",\n            "last_updated": "ISO timestamp"\n        }\n        '),
    sa.Column('has_tax_registration', sa.Boolean(), nullable=True),
    sa.Column('tax_id_type', sa.String(length=20), nullable=True, comment='GST, EIN, TRN, VAT, etc.'),
    sa.Column('tax_id_number', sa.String(length=50), nullable=True),
    sa.Column('tax_details', postgresql.JSON(astext_type=sa.Text()), nullable=True, comment='GST: {gstin, legal_name, trade_name, status, state, directors, additional_places, other_state_gstins}'),
    sa.Column('tax_verified', sa.Boolean(), nullable=True),
    sa.Column('tax_verified_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('pan_number', sa.String(length=10), nullable=True),
    sa.Column('pan_name', sa.String(length=500), nullable=True),
    sa.Column('pan_verified', sa.Boolean(), nullable=True),
    sa.Column('has_no_gst_declaration', sa.Boolean(), nullable=True),
    sa.Column('no_gst_declaration_url', sa.String(length=1000), nullable=True),
    sa.Column('declaration_reason', sa.String(length=200), nullable=True, comment='commission_agent, turnover_below_threshold, exempted_category'),
    sa.Column('bank_account_name', sa.String(length=200), nullable=False),
    sa.Column('bank_name', sa.String(length=200), nullable=False),
    sa.Column('bank_account_number', sa.String(length=100), nullable=False),
    sa.Column('bank_routing_code', sa.String(length=50), nullable=False, comment='IFSC (India), Routing (USA), SWIFT/IBAN (International)'),
    sa.Column('bank_verified', sa.Boolean(), nullable=True),
    sa.Column('primary_address', sa.Text(), nullable=False),
    sa.Column('primary_city', sa.String(length=100), nullable=False),
    sa.Column('primary_state', sa.String(length=100), nullable=True),
    sa.Column('primary_postal_code', sa.String(length=20), nullable=False),
    sa.Column('primary_country', sa.String(length=100), nullable=False),
    sa.Column('primary_latitude', sa.Numeric(precision=10, scale=7), nullable=True),
    sa.Column('primary_longitude', sa.Numeric(precision=10, scale=7), nullable=True),
    sa.Column('location_geocoded', sa.Boolean(), nullable=True),
    sa.Column('location_confidence', sa.Numeric(precision=5, scale=2), nullable=True, comment='Google Maps geocoding confidence 0-100'),
    sa.Column('primary_contact_name', sa.String(length=200), nullable=False),
    sa.Column('primary_contact_email', sa.String(length=200), nullable=False),
    sa.Column('primary_contact_phone', sa.String(length=20), nullable=False),
    sa.Column('primary_currency', sa.String(length=3), nullable=False),
    sa.Column('commodities', postgresql.JSON(astext_type=sa.Text()), nullable=True, comment='["cotton", "cotton_yarn", "textiles"]'),
    sa.Column('credit_limit', sa.Numeric(precision=20, scale=2), nullable=True),
    sa.Column('credit_utilized', sa.Numeric(precision=20, scale=2), nullable=True),
    sa.Column('payment_terms_days', sa.Integer(), nullable=True, comment='0=advance, 15, 30, 45'),
    sa.Column('monthly_purchase_volume', sa.String(length=100), nullable=True),
    sa.Column('production_capacity', sa.String(length=200), nullable=True),
    sa.Column('can_arrange_transport', sa.Boolean(), nullable=True),
    sa.Column('has_quality_lab', sa.Boolean(), nullable=True),
    sa.Column('service_details', postgresql.JSON(astext_type=sa.Text()), nullable=True, comment='Transporter: {fleet_size, routes, vehicle_types, has_own_vehicles, transport_license}, Broker: {license_number, exchange, commission_structure}'),
    sa.Column('risk_score', sa.Integer(), nullable=True, comment='0-100'),
    sa.Column('risk_category', sa.String(length=20), nullable=True, comment='low, medium, high, critical'),
    sa.Column('risk_assessment', postgresql.JSON(astext_type=sa.Text()), nullable=True, comment='Detailed scoring breakdown and flags'),
    sa.Column('last_risk_assessment_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('kyc_verified_at', sa.DateTime(timezone=True), nullable=True, comment='Initial KYC verification date (approval date)'),
    sa.Column('kyc_expiry_date', sa.Date(), nullable=True, comment='1 year from approval - triggers renewal'),
    sa.Column('kyc_status', sa.String(length=20), nullable=True, comment='pending, verified, expired, renewal_required'),
    sa.Column('last_kyc_renewal_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('status', sa.String(length=20), nullable=False, comment='pending, approved, rejected, suspended, inactive'),
    sa.Column('approved_by', sa.UUID(), nullable=True),
    sa.Column('approved_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('rejection_reason', sa.Text(), nullable=True),
    sa.Column('max_employees_allowed', sa.Integer(), nullable=True),
    sa.Column('current_employee_count', sa.Integer(), nullable=True),
    sa.Column('is_deleted', sa.Boolean(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('deleted_by', sa.UUID(), nullable=True),
    sa.Column('created_by', sa.UUID(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('NOW()'), nullable=False),
    sa.Column('updated_by', sa.UUID(), nullable=True),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['master_entity_id'], ['business_partners.id'], ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('partner_code')
    )
    op.create_index(op.f('ix_business_partners_corporate_group_id'), 'business_partners', ['corporate_group_id'], unique=False)
    op.create_index(op.f('ix_business_partners_country'), 'business_partners', ['country'], unique=False)
    op.create_index(op.f('ix_business_partners_entity_class'), 'business_partners', ['entity_class'], unique=False)
    op.create_index(op.f('ix_business_partners_legal_name'), 'business_partners', ['legal_name'], unique=False)
    op.create_index(op.f('ix_business_partners_master_entity_id'), 'business_partners', ['master_entity_id'], unique=False)
    op.create_index(op.f('ix_business_partners_pan_number'), 'business_partners', ['pan_number'], unique=False)
    op.create_index(op.f('ix_business_partners_tax_id_number'), 'business_partners', ['tax_id_number'], unique=True)
    op.create_table('capabilities',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('code', sa.String(length=100), nullable=False),
    sa.Column('name', sa.String(length=200), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('category', sa.String(length=50), nullable=False),
    sa.Column('is_system', sa.Boolean(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('NOW()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('NOW()'), nullable=False),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_capabilities_category'), 'capabilities', ['category'], unique=False)
    op.create_index(op.f('ix_capabilities_code'), 'capabilities', ['code'], unique=True)
    op.create_table('commodities',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('name', sa.String(length=200), nullable=False),
    sa.Column('category', sa.String(length=100), nullable=False),
    sa.Column('hsn_code', sa.String(length=20), nullable=True),
    sa.Column('gst_rate', sa.Numeric(precision=5, scale=2), nullable=True),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('uom', sa.String(length=50), nullable=True),
    sa.Column('base_unit', sa.String(length=50), server_default='KG', nullable=False),
    sa.Column('trade_unit', sa.String(length=50), nullable=True),
    sa.Column('rate_unit', sa.String(length=50), nullable=True),
    sa.Column('standard_weight_per_unit', sa.Numeric(precision=10, scale=2), nullable=True),
    sa.Column('default_currency', sa.String(length=3), server_default='USD', nullable=True),
    sa.Column('supported_currencies', postgresql.JSON(astext_type=sa.Text()), nullable=True),
    sa.Column('international_pricing_unit', sa.String(length=50), nullable=True),
    sa.Column('hs_code_6digit', sa.String(length=6), nullable=True),
    sa.Column('country_tax_codes', postgresql.JSON(astext_type=sa.Text()), nullable=True),
    sa.Column('quality_standards', postgresql.JSON(astext_type=sa.Text()), nullable=True),
    sa.Column('international_grades', postgresql.JSON(astext_type=sa.Text()), nullable=True),
    sa.Column('certification_required', postgresql.JSON(astext_type=sa.Text()), nullable=True),
    sa.Column('major_producing_countries', postgresql.JSON(astext_type=sa.Text()), nullable=True),
    sa.Column('major_consuming_countries', postgresql.JSON(astext_type=sa.Text()), nullable=True),
    sa.Column('trading_hubs', postgresql.JSON(astext_type=sa.Text()), nullable=True),
    sa.Column('traded_on_exchanges', postgresql.JSON(astext_type=sa.Text()), nullable=True),
    sa.Column('contract_specifications', postgresql.JSON(astext_type=sa.Text()), nullable=True),
    sa.Column('price_volatility', sa.String(length=20), nullable=True),
    sa.Column('export_regulations', postgresql.JSON(astext_type=sa.Text()), nullable=True),
    sa.Column('import_regulations', postgresql.JSON(astext_type=sa.Text()), nullable=True),
    sa.Column('phytosanitary_required', sa.Boolean(), nullable=False),
    sa.Column('fumigation_required', sa.Boolean(), nullable=False),
    sa.Column('seasonal_commodity', sa.Boolean(), nullable=False),
    sa.Column('harvest_season', postgresql.JSON(astext_type=sa.Text()), nullable=True),
    sa.Column('shelf_life_days', sa.Integer(), nullable=True),
    sa.Column('storage_conditions', postgresql.JSON(astext_type=sa.Text()), nullable=True),
    sa.Column('standard_lot_size', postgresql.JSON(astext_type=sa.Text()), nullable=True),
    sa.Column('min_order_quantity', postgresql.JSON(astext_type=sa.Text()), nullable=True),
    sa.Column('delivery_tolerance_pct', sa.Numeric(precision=5, scale=2), nullable=True),
    sa.Column('weight_tolerance_pct', sa.Numeric(precision=5, scale=2), nullable=True),
    sa.Column('is_active', sa.Boolean(), nullable=False),
    sa.Column('created_by', sa.UUID(), nullable=True),
    sa.Column('updated_by', sa.UUID(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('NOW()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_commodities_category'), 'commodities', ['category'], unique=False)
    op.create_index(op.f('ix_commodities_hs_code_6digit'), 'commodities', ['hs_code_6digit'], unique=False)
    op.create_index(op.f('ix_commodities_hsn_code'), 'commodities', ['hsn_code'], unique=False)
    op.create_index(op.f('ix_commodities_name'), 'commodities', ['name'], unique=False)
    op.create_table('consent_versions',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('consent_type', sa.Enum('ESSENTIAL', 'FUNCTIONAL', 'ANALYTICS', 'MARKETING', 'DATA_SHARING', 'PROFILING', name='consenttype'), nullable=False),
    sa.Column('version', sa.String(length=50), nullable=False),
    sa.Column('title', sa.String(length=255), nullable=False),
    sa.Column('description', sa.Text(), nullable=False),
    sa.Column('effective_date', sa.DateTime(timezone=True), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False),
    sa.Column('is_active', sa.Boolean(), nullable=False),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_consent_versions_consent_type'), 'consent_versions', ['consent_type'], unique=False)
    op.create_table('data_retention_policies',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('data_category', sa.Enum('USER_ACCOUNT', 'TRANSACTION', 'AUDIT_LOG', 'SESSION', 'CONSENT', 'COMMUNICATION', 'ANALYTICS', 'BACKUP', name='datacategory'), nullable=False),
    sa.Column('retention_days', sa.Integer(), nullable=False),
    sa.Column('description', sa.Text(), nullable=False),
    sa.Column('legal_basis', sa.Text(), nullable=True),
    sa.Column('auto_delete', sa.Boolean(), nullable=False),
    sa.Column('is_active', sa.Boolean(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_data_retention_policies_data_category'), 'data_retention_policies', ['data_category'], unique=True)
    op.create_table('delivery_terms',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('name', sa.String(length=100), nullable=False),
    sa.Column('code', sa.String(length=20), nullable=True),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('includes_freight', sa.Boolean(), nullable=False),
    sa.Column('includes_insurance', sa.Boolean(), nullable=False),
    sa.Column('is_active', sa.Boolean(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('NOW()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('code'),
    sa.UniqueConstraint('name')
    )
    op.create_table('event_outbox',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('aggregate_id', sa.UUID(), nullable=False),
    sa.Column('aggregate_type', sa.String(length=50), nullable=False),
    sa.Column('event_type', sa.String(length=100), nullable=False),
    sa.Column('payload', postgresql.JSONB(astext_type=sa.Text()), nullable=False),
    sa.Column('event_metadata', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column('status', sa.Enum('PENDING', 'PUBLISHED', 'FAILED', 'PROCESSING', name='outboxstatus'), nullable=False),
    sa.Column('retry_count', sa.Integer(), nullable=False),
    sa.Column('max_retries', sa.Integer(), nullable=False),
    sa.Column('next_retry_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('last_error', sa.Text(), nullable=True),
    sa.Column('topic_name', sa.String(length=200), nullable=False),
    sa.Column('message_id', sa.String(length=200), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('NOW()'), nullable=False),
    sa.Column('published_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('NOW()'), nullable=False),
    sa.Column('idempotency_key', sa.String(length=255), nullable=True),
    sa.Column('version', sa.Integer(), nullable=False),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_event_outbox_aggregate_id'), 'event_outbox', ['aggregate_id'], unique=False)
    op.create_index(op.f('ix_event_outbox_aggregate_type'), 'event_outbox', ['aggregate_type'], unique=False)
    op.create_index(op.f('ix_event_outbox_created_at'), 'event_outbox', ['created_at'], unique=False)
    op.create_index(op.f('ix_event_outbox_event_type'), 'event_outbox', ['event_type'], unique=False)
    op.create_index(op.f('ix_event_outbox_idempotency_key'), 'event_outbox', ['idempotency_key'], unique=True)
    op.create_index(op.f('ix_event_outbox_next_retry_at'), 'event_outbox', ['next_retry_at'], unique=False)
    op.create_index(op.f('ix_event_outbox_status'), 'event_outbox', ['status'], unique=False)
    op.create_index(op.f('ix_event_outbox_topic_name'), 'event_outbox', ['topic_name'], unique=False)
    op.create_table('events',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('event_type', sa.String(length=100), nullable=False),
    sa.Column('aggregate_id', sa.UUID(), nullable=False),
    sa.Column('aggregate_type', sa.String(length=50), nullable=False),
    sa.Column('user_id', sa.UUID(), nullable=False),
    sa.Column('timestamp', sa.DateTime(timezone=True), server_default=sa.text('NOW()'), nullable=False),
    sa.Column('version', sa.Integer(), nullable=False),
    sa.Column('data', postgresql.JSONB(astext_type=sa.Text()), nullable=False),
    sa.Column('event_metadata', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('NOW()'), nullable=False),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_events_aggregate_id'), 'events', ['aggregate_id'], unique=False)
    op.create_index(op.f('ix_events_aggregate_type'), 'events', ['aggregate_type'], unique=False)
    op.create_index(op.f('ix_events_event_type'), 'events', ['event_type'], unique=False)
    op.create_index(op.f('ix_events_timestamp'), 'events', ['timestamp'], unique=False)
    op.create_index(op.f('ix_events_user_id'), 'events', ['user_id'], unique=False)
    op.create_table('hsn_knowledge_base',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('commodity_name', sa.String(length=200), nullable=False),
    sa.Column('commodity_category', sa.String(length=100), nullable=True),
    sa.Column('hsn_code', sa.String(length=20), nullable=False),
    sa.Column('hsn_description', sa.Text(), nullable=True),
    sa.Column('gst_rate', sa.Numeric(precision=5, scale=2), nullable=False),
    sa.Column('source', sa.String(length=50), nullable=False),
    sa.Column('confidence', sa.Numeric(precision=3, scale=2), nullable=False),
    sa.Column('is_verified', sa.Boolean(), nullable=False),
    sa.Column('usage_count', sa.Numeric(precision=10, scale=0), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('NOW()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('created_by', sa.UUID(), nullable=True),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('commodity_name', 'hsn_code', name='uix_commodity_hsn')
    )
    op.create_index(op.f('ix_hsn_knowledge_base_commodity_category'), 'hsn_knowledge_base', ['commodity_category'], unique=False)
    op.create_index(op.f('ix_hsn_knowledge_base_commodity_name'), 'hsn_knowledge_base', ['commodity_name'], unique=False)
    op.create_index(op.f('ix_hsn_knowledge_base_hsn_code'), 'hsn_knowledge_base', ['hsn_code'], unique=False)
    op.create_table('organizations',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('name', sa.String(length=255), nullable=False),
    sa.Column('legal_name', sa.String(length=255), nullable=True),
    sa.Column('type', sa.String(length=64), nullable=True),
    sa.Column('CIN', sa.String(length=21), nullable=True),
    sa.Column('PAN', sa.String(length=10), nullable=True),
    sa.Column('base_currency', sa.String(length=3), nullable=False),
    sa.Column('address_line1', sa.String(length=255), nullable=True),
    sa.Column('address_line2', sa.String(length=255), nullable=True),
    sa.Column('city', sa.String(length=128), nullable=True),
    sa.Column('state', sa.String(length=128), nullable=True),
    sa.Column('pincode', sa.String(length=16), nullable=True),
    sa.Column('contact_email', sa.String(length=255), nullable=True),
    sa.Column('contact_phone', sa.String(length=32), nullable=True),
    sa.Column('is_active', sa.Boolean(), nullable=False),
    sa.Column('threshold_limit', sa.Integer(), nullable=True),
    sa.Column('einvoice_required', sa.Boolean(), nullable=False),
    sa.Column('auto_block_if_einvoice_required', sa.Boolean(), nullable=False),
    sa.Column('fx_enabled', sa.Boolean(), nullable=False),
    sa.Column('logo_url', sa.String(length=255), nullable=True),
    sa.Column('theme_color', sa.String(length=64), nullable=True),
    sa.Column('invoice_footer', sa.String(length=1024), nullable=True),
    sa.Column('digital_signature_url', sa.String(length=255), nullable=True),
    sa.Column('tds_rate', sa.Integer(), nullable=True),
    sa.Column('tcs_rate', sa.Integer(), nullable=True),
    sa.Column('audit_firm_name', sa.String(length=255), nullable=True),
    sa.Column('audit_firm_email', sa.String(length=255), nullable=True),
    sa.Column('audit_firm_phone', sa.String(length=32), nullable=True),
    sa.Column('gst_audit_required', sa.Boolean(), nullable=False),
    sa.Column('auto_invoice', sa.Boolean(), nullable=False),
    sa.Column('auto_contract_number', sa.Boolean(), nullable=False),
    sa.Column('extra_config', postgresql.JSONB(astext_type=sa.Text()), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('name')
    )
    op.create_table('passing_terms',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('name', sa.String(length=100), nullable=False),
    sa.Column('code', sa.String(length=20), nullable=True),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('requires_quality_test', sa.Boolean(), nullable=False),
    sa.Column('is_active', sa.Boolean(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('NOW()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('code'),
    sa.UniqueConstraint('name')
    )
    op.create_table('payment_terms',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('name', sa.String(length=100), nullable=False),
    sa.Column('code', sa.String(length=20), nullable=True),
    sa.Column('days', sa.Integer(), nullable=True),
    sa.Column('payment_percentage', sa.Numeric(precision=5, scale=2), nullable=True),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('currency', sa.String(length=3), nullable=True),
    sa.Column('supports_multi_currency', sa.Boolean(), nullable=False),
    sa.Column('supports_letter_of_credit', sa.Boolean(), nullable=False),
    sa.Column('lc_types_supported', postgresql.JSON(astext_type=sa.Text()), nullable=True),
    sa.Column('lc_confirmation_required', sa.Boolean(), nullable=False),
    sa.Column('bank_charges_borne_by', sa.String(length=20), nullable=True),
    sa.Column('forex_adjustment_applicable', sa.Boolean(), nullable=False),
    sa.Column('payment_methods_supported', postgresql.JSON(astext_type=sa.Text()), nullable=True),
    sa.Column('swift_required', sa.Boolean(), nullable=False),
    sa.Column('is_active', sa.Boolean(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('NOW()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('code'),
    sa.UniqueConstraint('name')
    )
    op.create_table('permissions',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('code', sa.String(length=128), nullable=False),
    sa.Column('description', sa.String(length=255), nullable=True),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('code')
    )
    op.create_table('roles',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('name', sa.String(length=128), nullable=False),
    sa.Column('description', sa.String(length=255), nullable=True),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('name')
    )
    op.create_table('settings_locations',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('name', sa.String(length=255), nullable=False),
    sa.Column('google_place_id', sa.String(length=255), nullable=False),
    sa.Column('address', sa.Text(), nullable=True),
    sa.Column('latitude', sa.Float(), nullable=True),
    sa.Column('longitude', sa.Float(), nullable=True),
    sa.Column('pincode', sa.String(length=20), nullable=True),
    sa.Column('city', sa.String(length=100), nullable=True),
    sa.Column('district', sa.String(length=100), nullable=True),
    sa.Column('state', sa.String(length=100), nullable=True),
    sa.Column('state_code', sa.String(length=10), nullable=True),
    sa.Column('country', sa.String(length=100), nullable=True),
    sa.Column('region', sa.String(length=50), nullable=True),
    sa.Column('timezone', sa.String(length=50), nullable=True, comment='IANA timezone (e.g., Asia/Kolkata, America/New_York) for EOD cutoff calculations'),
    sa.Column('is_active', sa.Boolean(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('created_by', sa.UUID(), nullable=True),
    sa.Column('updated_by', sa.UUID(), nullable=True),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('google_place_id')
    )
    op.create_index('ix_settings_locations_city', 'settings_locations', ['city'], unique=False)
    op.create_index('ix_settings_locations_google_place_id', 'settings_locations', ['google_place_id'], unique=False)
    op.create_index('ix_settings_locations_is_active', 'settings_locations', ['is_active'], unique=False)
    op.create_index('ix_settings_locations_pincode', 'settings_locations', ['pincode'], unique=False)
    op.create_index('ix_settings_locations_region', 'settings_locations', ['region'], unique=False)
    op.create_index('ix_settings_locations_state', 'settings_locations', ['state'], unique=False)
    op.create_table('system_commodity_parameters',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('commodity_category', sa.String(length=100), nullable=False),
    sa.Column('parameter_name', sa.String(length=100), nullable=False),
    sa.Column('parameter_type', sa.String(length=50), nullable=False),
    sa.Column('unit', sa.String(length=50), nullable=True),
    sa.Column('min_value', sa.Numeric(precision=10, scale=2), nullable=True),
    sa.Column('max_value', sa.Numeric(precision=10, scale=2), nullable=True),
    sa.Column('default_value', sa.String(length=100), nullable=True),
    sa.Column('is_mandatory', sa.Boolean(), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('usage_count', sa.Integer(), nullable=False),
    sa.Column('source', sa.String(length=100), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('NOW()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('created_by', sa.UUID(), nullable=True),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('commodity_category', 'parameter_name', name='uix_category_parameter')
    )
    op.create_index(op.f('ix_system_commodity_parameters_commodity_category'), 'system_commodity_parameters', ['commodity_category'], unique=False)
    op.create_table('trade_types',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('name', sa.String(length=100), nullable=False),
    sa.Column('code', sa.String(length=20), nullable=True),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('is_active', sa.Boolean(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('NOW()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('code'),
    sa.UniqueConstraint('name')
    )
    op.create_table('user_right_requests',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('user_id', sa.UUID(), nullable=False),
    sa.Column('request_type', sa.Enum('ACCESS', 'RECTIFICATION', 'ERASURE', 'RESTRICTION', 'PORTABILITY', 'OBJECTION', name='userrighttype'), nullable=False),
    sa.Column('status', sa.Enum('PENDING', 'IN_PROGRESS', 'COMPLETED', 'REJECTED', name='requeststatus'), nullable=False),
    sa.Column('requested_at', sa.DateTime(timezone=True), nullable=False),
    sa.Column('completed_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('rejected_reason', sa.Text(), nullable=True),
    sa.Column('request_metadata', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_user_right_requests_user_id'), 'user_right_requests', ['user_id'], unique=False)
    op.create_table('user_sessions',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('user_id', sa.UUID(), nullable=False, comment='User who owns this session'),
    sa.Column('device_fingerprint', sa.String(length=64), nullable=False, comment='SHA256 hash of user-agent (for device identification)'),
    sa.Column('device_name', sa.String(length=255), nullable=False, comment="Friendly device name (e.g., 'iPhone 13 (iOS 15.0)')"),
    sa.Column('device_type', sa.String(length=50), nullable=False, comment='mobile, desktop, tablet, bot'),
    sa.Column('os_name', sa.String(length=100), nullable=True, comment='Operating system (iOS, Android, Windows, macOS)'),
    sa.Column('os_version', sa.String(length=50), nullable=True, comment='OS version'),
    sa.Column('browser_name', sa.String(length=100), nullable=True, comment='Browser name (Chrome, Safari, Firefox)'),
    sa.Column('browser_version', sa.String(length=50), nullable=True, comment='Browser version'),
    sa.Column('ip_address', sa.String(length=45), nullable=False, comment='IP address (IPv4 or IPv6)'),
    sa.Column('user_agent', sa.Text(), nullable=False, comment='Full User-Agent header'),
    sa.Column('refresh_token_jti', sa.String(length=64), nullable=False, comment='JWT ID of current refresh token'),
    sa.Column('access_token_jti', sa.String(length=64), nullable=False, comment='JWT ID of current access token'),
    sa.Column('access_token_expires_at', sa.DateTime(timezone=True), nullable=False, comment='Access token expiration'),
    sa.Column('refresh_token_expires_at', sa.DateTime(timezone=True), nullable=False, comment='Refresh token expiration (session expiry)'),
    sa.Column('last_active_at', sa.DateTime(timezone=True), nullable=False, comment='Last API request from this session'),
    sa.Column('is_active', sa.Boolean(), nullable=False, comment='Session is active (not logged out)'),
    sa.Column('is_suspicious', sa.Boolean(), nullable=False, comment='Flagged as suspicious login'),
    sa.Column('suspicious_reason', sa.String(length=500), nullable=True, comment='Why flagged as suspicious'),
    sa.Column('is_verified', sa.Boolean(), nullable=False, comment='Device verified via email/SMS'),
    sa.Column('total_logins', sa.Integer(), nullable=False, comment='Total logins from this device'),
    sa.Column('failed_logins_last_24h', sa.Integer(), nullable=False, comment='Failed login attempts (security monitoring)'),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False, comment='Session created (first login)'),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True, comment='Last updated'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_user_sessions_device_fingerprint'), 'user_sessions', ['device_fingerprint'], unique=False)
    op.create_index(op.f('ix_user_sessions_is_active'), 'user_sessions', ['is_active'], unique=False)
    op.create_index(op.f('ix_user_sessions_last_active_at'), 'user_sessions', ['last_active_at'], unique=False)
    op.create_index(op.f('ix_user_sessions_refresh_token_expires_at'), 'user_sessions', ['refresh_token_expires_at'], unique=False)
    op.create_index(op.f('ix_user_sessions_refresh_token_jti'), 'user_sessions', ['refresh_token_jti'], unique=True)
    op.create_index(op.f('ix_user_sessions_user_id'), 'user_sessions', ['user_id'], unique=False)
    op.create_table('weightment_terms',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('name', sa.String(length=100), nullable=False),
    sa.Column('code', sa.String(length=20), nullable=True),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('weight_deduction_percent', sa.Numeric(precision=5, scale=2), nullable=True),
    sa.Column('is_active', sa.Boolean(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('NOW()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('code'),
    sa.UniqueConstraint('name')
    )
    op.create_table('commission_structures',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('commodity_id', sa.UUID(), nullable=True),
    sa.Column('trade_type_id', sa.UUID(), nullable=True),
    sa.Column('name', sa.String(length=100), nullable=False),
    sa.Column('commission_type', sa.String(length=50), nullable=False),
    sa.Column('rate', sa.Numeric(precision=5, scale=2), nullable=True),
    sa.Column('min_amount', sa.Numeric(precision=15, scale=2), nullable=True),
    sa.Column('max_amount', sa.Numeric(precision=15, scale=2), nullable=True),
    sa.Column('applies_to', sa.String(length=50), nullable=True),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('currency', sa.String(length=3), server_default='INR', nullable=True),
    sa.Column('rate_per_country', postgresql.JSON(astext_type=sa.Text()), nullable=True),
    sa.Column('forex_adjustment', sa.Numeric(precision=5, scale=2), nullable=True),
    sa.Column('apply_forex_on_cross_border', sa.Boolean(), nullable=False),
    sa.Column('international_tier_rates', postgresql.JSON(astext_type=sa.Text()), nullable=True),
    sa.Column('is_active', sa.Boolean(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('NOW()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['commodity_id'], ['commodities.id'], ),
    sa.ForeignKeyConstraint(['trade_type_id'], ['trade_types.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('commodity_parameters',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('commodity_id', sa.UUID(), nullable=False),
    sa.Column('parameter_name', sa.String(length=100), nullable=False),
    sa.Column('parameter_type', sa.String(length=50), nullable=False),
    sa.Column('unit', sa.String(length=50), nullable=True),
    sa.Column('min_value', sa.Numeric(precision=10, scale=2), nullable=True),
    sa.Column('max_value', sa.Numeric(precision=10, scale=2), nullable=True),
    sa.Column('default_value', sa.String(length=100), nullable=True),
    sa.Column('is_mandatory', sa.Boolean(), nullable=False),
    sa.Column('display_order', sa.Integer(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('NOW()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['commodity_id'], ['commodities.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('commodity_varieties',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('commodity_id', sa.UUID(), nullable=False),
    sa.Column('name', sa.String(length=200), nullable=False),
    sa.Column('code', sa.String(length=50), nullable=True),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('is_standard', sa.Boolean(), nullable=False),
    sa.Column('is_active', sa.Boolean(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('NOW()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['commodity_id'], ['commodities.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('organization_bank_accounts',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('organization_id', sa.UUID(), nullable=False),
    sa.Column('account_holder', sa.String(length=255), nullable=False),
    sa.Column('bank_name', sa.String(length=255), nullable=False),
    sa.Column('account_number', sa.String(length=64), nullable=False),
    sa.Column('ifsc', sa.String(length=11), nullable=True),
    sa.Column('branch', sa.String(length=255), nullable=True),
    sa.Column('is_default', sa.Boolean(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['organization_id'], ['organizations.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('organization_financial_years',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('organization_id', sa.UUID(), nullable=False),
    sa.Column('start_date', sa.Date(), nullable=False),
    sa.Column('end_date', sa.Date(), nullable=False),
    sa.Column('is_active', sa.Boolean(), nullable=False),
    sa.Column('allow_year_split', sa.Boolean(), nullable=False),
    sa.Column('version', sa.Integer(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['organization_id'], ['organizations.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('organization_gst',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('organization_id', sa.UUID(), nullable=False),
    sa.Column('gstin', sa.String(length=15), nullable=False),
    sa.Column('legal_name', sa.String(length=255), nullable=True),
    sa.Column('address', sa.String(length=255), nullable=True),
    sa.Column('state', sa.String(length=128), nullable=True),
    sa.Column('branch_code', sa.String(length=32), nullable=True),
    sa.Column('is_primary', sa.Boolean(), nullable=False),
    sa.Column('is_active', sa.Boolean(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['organization_id'], ['organizations.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('gstin')
    )
    op.create_table('partner_amendments',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('partner_id', sa.UUID(), nullable=False),
    sa.Column('amendment_type', sa.String(length=50), nullable=False, comment='add_location, change_bank, update_gst, increase_credit_limit, add_employee'),
    sa.Column('field_changed', sa.String(length=100), nullable=True),
    sa.Column('old_value', postgresql.JSON(astext_type=sa.Text()), nullable=True),
    sa.Column('new_value', postgresql.JSON(astext_type=sa.Text()), nullable=True),
    sa.Column('reason', sa.Text(), nullable=True),
    sa.Column('supporting_documents', postgresql.JSON(astext_type=sa.Text()), nullable=True, comment='Document IDs'),
    sa.Column('status', sa.String(length=20), nullable=True, comment='pending, approved, rejected'),
    sa.Column('requested_by', sa.UUID(), nullable=False),
    sa.Column('approved_by', sa.UUID(), nullable=True),
    sa.Column('requested_at', sa.DateTime(timezone=True), server_default=sa.text('NOW()'), nullable=True),
    sa.Column('approved_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('chat_transcript', postgresql.JSON(astext_type=sa.Text()), nullable=True),
    sa.ForeignKeyConstraint(['partner_id'], ['business_partners.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('partner_branches',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('partner_id', sa.UUID(), nullable=False, comment='Link to business partner'),
    sa.Column('branch_code', sa.String(length=50), nullable=False, comment='Unique code within partner (HO, WH-01, etc.)'),
    sa.Column('branch_name', sa.String(length=200), nullable=False, comment="Display name (e.g., 'Head Office - Mumbai')"),
    sa.Column('branch_type', sa.String(length=50), nullable=True, comment='head_office, warehouse, sales_office, factory, etc.'),
    sa.Column('address_line_1', sa.String(length=200), nullable=False),
    sa.Column('address_line_2', sa.String(length=200), nullable=True),
    sa.Column('city', sa.String(length=100), nullable=False),
    sa.Column('state', sa.String(length=100), nullable=False, comment='For GST calculation'),
    sa.Column('postal_code', sa.String(length=20), nullable=False),
    sa.Column('country', sa.String(length=100), nullable=False),
    sa.Column('latitude', sa.Numeric(precision=10, scale=7), nullable=True, comment='For distance calculation'),
    sa.Column('longitude', sa.Numeric(precision=10, scale=7), nullable=True, comment='For distance calculation'),
    sa.Column('gstin', sa.String(length=15), nullable=True, comment='Branch-specific GSTIN if different from head office'),
    sa.Column('can_receive_shipments', sa.Boolean(), nullable=True, comment='Can be used as ship-to address'),
    sa.Column('can_send_shipments', sa.Boolean(), nullable=True, comment='Can be used as ship-from address'),
    sa.Column('warehouse_capacity_qtls', sa.Integer(), nullable=True, comment='Total warehouse capacity in quintals (for AI scoring)'),
    sa.Column('current_stock_qtls', sa.Integer(), nullable=True, comment='Current stock level (updated by inventory module)'),
    sa.Column('supported_commodities', postgresql.JSON(astext_type=sa.Text()), nullable=True, comment='Array of commodity codes this branch can handle'),
    sa.Column('is_head_office', sa.Boolean(), nullable=True, comment='Is this the head office (default bill-to)'),
    sa.Column('is_default_ship_to', sa.Boolean(), nullable=True, comment='Default ship-to address'),
    sa.Column('is_default_ship_from', sa.Boolean(), nullable=True, comment='Default ship-from address'),
    sa.Column('is_active', sa.Boolean(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('NOW()'), nullable=True),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('NOW()'), nullable=True),
    sa.Column('created_by', sa.UUID(), nullable=True),
    sa.ForeignKeyConstraint(['partner_id'], ['business_partners.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_partner_branches_city'), 'partner_branches', ['city'], unique=False)
    op.create_index(op.f('ix_partner_branches_partner_id'), 'partner_branches', ['partner_id'], unique=False)
    op.create_index(op.f('ix_partner_branches_state'), 'partner_branches', ['state'], unique=False)
    op.create_table('partner_documents',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('partner_id', sa.UUID(), nullable=False),
    sa.Column('document_type', sa.String(length=100), nullable=False, comment='gst_certificate, pan_card, bank_proof, transport_license, vehicle_rc, etc.'),
    sa.Column('document_subtype', sa.String(length=100), nullable=True),
    sa.Column('country', sa.String(length=100), nullable=False),
    sa.Column('file_url', sa.String(length=1000), nullable=False),
    sa.Column('file_name', sa.String(length=500), nullable=True),
    sa.Column('file_size', sa.Integer(), nullable=True),
    sa.Column('mime_type', sa.String(length=100), nullable=True),
    sa.Column('ocr_extracted_data', postgresql.JSON(astext_type=sa.Text()), nullable=True),
    sa.Column('extraction_confidence', sa.Numeric(precision=5, scale=2), nullable=True),
    sa.Column('issue_date', sa.Date(), nullable=True),
    sa.Column('expiry_date', sa.Date(), nullable=True),
    sa.Column('is_expired', sa.Boolean(), nullable=True),
    sa.Column('verified', sa.Boolean(), nullable=True),
    sa.Column('verified_by', sa.UUID(), nullable=True),
    sa.Column('verified_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('uploaded_at', sa.DateTime(timezone=True), server_default=sa.text('NOW()'), nullable=True),
    sa.ForeignKeyConstraint(['partner_id'], ['business_partners.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('partner_kyc_renewals',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('partner_id', sa.UUID(), nullable=False),
    sa.Column('renewal_type', sa.String(length=20), nullable=True, comment='annual, adhoc'),
    sa.Column('renewal_due_date', sa.Date(), nullable=False),
    sa.Column('renewal_requested_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('renewal_completed_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('documents_verified', postgresql.JSON(astext_type=sa.Text()), nullable=True, comment='List of document IDs verified'),
    sa.Column('tax_re_verified', sa.Boolean(), nullable=True),
    sa.Column('bank_re_verified', sa.Boolean(), nullable=True),
    sa.Column('risk_re_assessed', sa.Boolean(), nullable=True),
    sa.Column('new_risk_score', sa.Integer(), nullable=True),
    sa.Column('status', sa.String(length=20), nullable=True, comment='pending, in_progress, completed, expired'),
    sa.Column('completed_by', sa.UUID(), nullable=True),
    sa.Column('notes', sa.Text(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('NOW()'), nullable=True),
    sa.ForeignKeyConstraint(['partner_id'], ['business_partners.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('partner_locations',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('partner_id', sa.UUID(), nullable=False),
    sa.Column('location_type', sa.String(length=50), nullable=False, comment='principal, additional_same_state, branch_different_state, warehouse, factory, ship_to, bill_to'),
    sa.Column('location_name', sa.String(length=200), nullable=False),
    sa.Column('is_from_gst', sa.Boolean(), nullable=True, comment='Auto-fetched from GST API'),
    sa.Column('gstin_for_location', sa.String(length=15), nullable=True, comment='Different GSTIN if different state'),
    sa.Column('requires_gst', sa.Boolean(), nullable=True),
    sa.Column('address', sa.Text(), nullable=False),
    sa.Column('city', sa.String(length=100), nullable=False),
    sa.Column('state', sa.String(length=100), nullable=True),
    sa.Column('postal_code', sa.String(length=20), nullable=False),
    sa.Column('country', sa.String(length=100), nullable=False),
    sa.Column('latitude', sa.Numeric(precision=10, scale=7), nullable=True),
    sa.Column('longitude', sa.Numeric(precision=10, scale=7), nullable=True),
    sa.Column('geocoded', sa.Boolean(), nullable=True),
    sa.Column('geocode_confidence', sa.Numeric(precision=5, scale=2), nullable=True),
    sa.Column('contact_person', sa.String(length=200), nullable=True),
    sa.Column('contact_phone', sa.String(length=20), nullable=True),
    sa.Column('status', sa.String(length=20), nullable=True),
    sa.Column('is_deleted', sa.Boolean(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('NOW()'), nullable=True),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['partner_id'], ['business_partners.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('partner_vehicles',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('partner_id', sa.UUID(), nullable=False),
    sa.Column('vehicle_number', sa.String(length=20), nullable=False),
    sa.Column('vehicle_type', sa.String(length=50), nullable=False, comment='truck, trailer, container, etc.'),
    sa.Column('owner_name', sa.String(length=200), nullable=True),
    sa.Column('maker_model', sa.String(length=200), nullable=True),
    sa.Column('capacity_tons', sa.Numeric(precision=10, scale=2), nullable=True),
    sa.Column('registration_date', sa.Date(), nullable=True),
    sa.Column('rc_document_url', sa.String(length=1000), nullable=True),
    sa.Column('insurance_valid_till', sa.Date(), nullable=True),
    sa.Column('fitness_valid_till', sa.Date(), nullable=True),
    sa.Column('permit_type', sa.String(length=100), nullable=True),
    sa.Column('verified_via_rto', sa.Boolean(), nullable=True),
    sa.Column('rto_data', postgresql.JSON(astext_type=sa.Text()), nullable=True, comment='Data from Parivahan/Vahan API'),
    sa.Column('status', sa.String(length=20), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('NOW()'), nullable=True),
    sa.ForeignKeyConstraint(['partner_id'], ['business_partners.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_partner_vehicles_vehicle_number'), 'partner_vehicles', ['vehicle_number'], unique=True)
    op.create_table('role_permissions',
    sa.Column('role_id', sa.UUID(), nullable=False),
    sa.Column('permission_id', sa.UUID(), nullable=False),
    sa.ForeignKeyConstraint(['permission_id'], ['permissions.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['role_id'], ['roles.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('role_id', 'permission_id'),
    sa.UniqueConstraint('role_id', 'permission_id', name='uq_role_permission')
    )
    op.create_table('user_consents',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('user_id', sa.UUID(), nullable=False),
    sa.Column('consent_type', sa.Enum('ESSENTIAL', 'FUNCTIONAL', 'ANALYTICS', 'MARKETING', 'DATA_SHARING', 'PROFILING', name='consenttype'), nullable=False),
    sa.Column('consent_version_id', sa.UUID(), nullable=False),
    sa.Column('given', sa.Boolean(), nullable=False),
    sa.Column('given_at', sa.DateTime(timezone=True), nullable=False),
    sa.Column('withdrawn_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('ip_address', sa.String(length=45), nullable=True),
    sa.Column('user_agent', sa.Text(), nullable=True),
    sa.Column('method', sa.String(length=50), nullable=True),
    sa.Column('notes', sa.Text(), nullable=True),
    sa.ForeignKeyConstraint(['consent_version_id'], ['consent_versions.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_user_consents_consent_type'), 'user_consents', ['consent_type'], unique=False)
    op.create_index(op.f('ix_user_consents_user_id'), 'user_consents', ['user_id'], unique=False)
    op.create_table('users',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('user_type', sa.String(length=20), nullable=False, comment='SUPER_ADMIN, INTERNAL, or EXTERNAL'),
    sa.Column('business_partner_id', sa.UUID(), nullable=True, comment='For EXTERNAL users only'),
    sa.Column('organization_id', sa.UUID(), nullable=True, comment='For INTERNAL users only'),
    sa.Column('parent_user_id', sa.UUID(), nullable=True, comment='Parent user ID for sub-users (max 2 per parent)'),
    sa.Column('allowed_modules', postgresql.ARRAY(sa.String()), nullable=True, comment='RBAC: List of modules user can access'),
    sa.Column('two_fa_enabled', sa.Boolean(), nullable=False, comment='Whether 2FA with PIN is enabled for this user'),
    sa.Column('pin_hash', sa.String(length=255), nullable=True, comment='Hashed 4-6 digit PIN for 2FA verification'),
    sa.Column('email', sa.String(length=255), nullable=True),
    sa.Column('mobile_number', sa.String(length=20), nullable=True, comment='Mobile number for OTP authentication'),
    sa.Column('full_name', sa.String(length=255), nullable=True),
    sa.Column('password_hash', sa.String(length=255), nullable=True, comment='Null for OTP-only users'),
    sa.Column('is_active', sa.Boolean(), nullable=False),
    sa.Column('is_verified', sa.Boolean(), nullable=False, comment='Mobile/email verified via OTP'),
    sa.Column('role', sa.String(length=50), nullable=True, comment='User role: partner_user, manager, director, etc.'),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False),
    sa.CheckConstraint("\n\t\t\t(user_type = 'SUPER_ADMIN' AND business_partner_id IS NULL AND organization_id IS NULL) OR\n\t\t\t(user_type = 'INTERNAL' AND business_partner_id IS NULL AND organization_id IS NOT NULL) OR\n\t\t\t(user_type = 'EXTERNAL' AND business_partner_id IS NOT NULL AND organization_id IS NULL)\n\t\t\t", name='ck_user_type_isolation'),
    sa.CheckConstraint("email <> ''", name='ck_user_email_nonempty'),
    sa.CheckConstraint('email IS NOT NULL OR mobile_number IS NOT NULL', name='ck_user_has_email_or_mobile'),
    sa.ForeignKeyConstraint(['business_partner_id'], ['business_partners.id'], ondelete='RESTRICT'),
    sa.ForeignKeyConstraint(['organization_id'], ['organizations.id'], ondelete='RESTRICT'),
    sa.ForeignKeyConstraint(['parent_user_id'], ['users.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('email')
    )
    op.create_index(op.f('ix_users_mobile_number'), 'users', ['mobile_number'], unique=True)
    op.create_table('availabilities',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('commodity_id', sa.UUID(), nullable=False),
    sa.Column('location_id', sa.UUID(), nullable=True, comment='Registered location ID (NULL for ad-hoc Google Maps locations)'),
    sa.Column('seller_partner_id', sa.UUID(), nullable=False),
    sa.Column('total_quantity', sa.Numeric(precision=15, scale=3), nullable=False),
    sa.Column('quantity_unit', sa.String(length=20), nullable=False, comment='Unit of quantity: BALE, BAG, KG, MT, CANDY, QTL, etc.'),
    sa.Column('quantity_in_base_unit', sa.Numeric(precision=18, scale=6), nullable=True, comment='Auto-calculated quantity in commodity base_unit (KG/METER/LITER)'),
    sa.Column('available_quantity', sa.Numeric(precision=15, scale=3), nullable=False),
    sa.Column('reserved_quantity', sa.Numeric(precision=15, scale=3), nullable=False),
    sa.Column('sold_quantity', sa.Numeric(precision=15, scale=3), nullable=False),
    sa.Column('min_order_quantity', sa.Numeric(precision=15, scale=3), nullable=True),
    sa.Column('allow_partial_order', sa.Boolean(), nullable=False),
    sa.Column('price_type', sa.String(length=20), nullable=False),
    sa.Column('base_price', sa.Numeric(precision=15, scale=2), nullable=True),
    sa.Column('price_unit', sa.String(length=20), nullable=True, comment='Unit for pricing: per KG, per CANDY, per MT, per BALE'),
    sa.Column('price_per_base_unit', sa.Numeric(precision=15, scale=2), nullable=True, comment='Auto-calculated price per base_unit for consistent matching'),
    sa.Column('price_matrix', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column('quality_params', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column('test_report_url', sa.String(length=500), nullable=True, comment='PDF/Image URL of lab test report'),
    sa.Column('test_report_verified', sa.Boolean(), nullable=False),
    sa.Column('test_report_data', postgresql.JSONB(astext_type=sa.Text()), nullable=True, comment='AI-extracted parameters from test report: {"length": 29.0, "source": "OCR"}'),
    sa.Column('media_urls', postgresql.JSONB(astext_type=sa.Text()), nullable=True, comment='Photo/video URLs for AI quality detection: {"photos": [url1, url2], "videos": [url3]}'),
    sa.Column('ai_detected_params', postgresql.JSONB(astext_type=sa.Text()), nullable=True, comment='AI-detected quality from photos/videos: {"color": "white", "trash": 2.5, "confidence": 0.85}'),
    sa.Column('manual_override_params', sa.Boolean(), nullable=False, comment='True if seller manually overrode AI-detected parameters'),
    sa.Column('ai_score_vector', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column('ai_suggested_price', sa.Numeric(precision=15, scale=2), nullable=True),
    sa.Column('ai_confidence_score', sa.Numeric(precision=5, scale=4), nullable=True),
    sa.Column('ai_price_anomaly_flag', sa.Boolean(), nullable=False),
    sa.Column('expected_price', sa.Numeric(precision=15, scale=2), nullable=True),
    sa.Column('estimated_trade_value', sa.Numeric(precision=18, scale=2), nullable=True),
    sa.Column('risk_precheck_status', sa.String(length=20), nullable=True),
    sa.Column('risk_precheck_score', sa.Integer(), nullable=True),
    sa.Column('seller_exposure_after_trade', sa.Numeric(precision=18, scale=2), nullable=True),
    sa.Column('seller_branch_id', sa.UUID(), nullable=True, comment='Seller branch/location ID (from partner_locations table) for internal trade blocking logic'),
    sa.Column('blocked_for_branches', sa.Boolean(), nullable=False),
    sa.Column('seller_rating_score', sa.Numeric(precision=3, scale=2), nullable=True),
    sa.Column('seller_delivery_score', sa.Integer(), nullable=True),
    sa.Column('risk_flags', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column('market_visibility', sa.String(length=20), nullable=False),
    sa.Column('restricted_buyers', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column('delivery_terms', sa.String(length=50), nullable=True),
    sa.Column('delivery_address', sa.Text(), nullable=True),
    sa.Column('delivery_latitude', sa.Numeric(precision=10, scale=7), nullable=True),
    sa.Column('delivery_longitude', sa.Numeric(precision=10, scale=7), nullable=True),
    sa.Column('delivery_region', sa.String(length=50), nullable=True),
    sa.Column('currency_code', sa.String(length=3), nullable=False, comment='Currency code (ISO 4217): INR, USD, EUR, etc.'),
    sa.Column('country_of_origin', sa.String(length=2), nullable=True, comment='ISO 3166-1 alpha-2 country code (IN, US, BR, etc.)'),
    sa.Column('supported_incoterms', postgresql.JSONB(astext_type=sa.Text()), nullable=True, comment='Array of supported Incoterms: ["FOB", "CIF", "EXW", "DDP"]'),
    sa.Column('export_port', sa.String(length=255), nullable=True, comment='Port code for international shipments (e.g., INNSA for Nhava Sheva)'),
    sa.Column('available_from', sa.DateTime(timezone=True), nullable=True),
    sa.Column('available_until', sa.DateTime(timezone=True), nullable=True),
    sa.Column('expiry_date', sa.DateTime(timezone=True), nullable=True),
    sa.Column('eod_cutoff', sa.DateTime(timezone=True), nullable=True, comment='End-of-day cutoff time (timezone-aware). Availability expires at this time.'),
    sa.Column('status', sa.String(length=20), nullable=False),
    sa.Column('approval_status', sa.String(length=20), nullable=False),
    sa.Column('approval_notes', sa.Text(), nullable=True),
    sa.Column('approved_by', sa.UUID(), nullable=True),
    sa.Column('approved_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('notes', sa.Text(), nullable=True),
    sa.Column('internal_reference', sa.String(length=100), nullable=True),
    sa.Column('tags', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column('created_by', sa.UUID(), nullable=False),
    sa.Column('updated_by', sa.UUID(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('NOW()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('is_deleted', sa.Boolean(), nullable=False),
    sa.Column('deleted_by', sa.UUID(), nullable=True),
    sa.Column('deleted_at', sa.DateTime(timezone=True), nullable=True),
    sa.CheckConstraint("risk_precheck_status IS NULL OR risk_precheck_status IN ('PASS', 'WARN', 'FAIL')", name='check_risk_precheck_status_valid'),
    sa.CheckConstraint('available_quantity >= 0', name='check_available_quantity_non_negative'),
    sa.CheckConstraint('available_until IS NULL OR available_from IS NULL OR available_until > available_from', name='check_date_range_valid'),
    sa.CheckConstraint('base_price IS NULL OR base_price > 0', name='check_base_price_positive'),
    sa.CheckConstraint('expected_price IS NULL OR expected_price > 0', name='check_expected_price_positive'),
    sa.CheckConstraint('min_order_quantity IS NULL OR min_order_quantity > 0', name='check_min_order_quantity_positive'),
    sa.CheckConstraint('reserved_quantity >= 0', name='check_reserved_quantity_non_negative'),
    sa.CheckConstraint('risk_precheck_score IS NULL OR (risk_precheck_score >= 0 AND risk_precheck_score <= 100)', name='check_risk_precheck_score_range'),
    sa.CheckConstraint('seller_delivery_score IS NULL OR (seller_delivery_score >= 0 AND seller_delivery_score <= 100)', name='check_seller_delivery_score_range'),
    sa.CheckConstraint('seller_rating_score IS NULL OR (seller_rating_score >= 0 AND seller_rating_score <= 5)', name='check_seller_rating_score_range'),
    sa.CheckConstraint('sold_quantity >= 0', name='check_sold_quantity_non_negative'),
    sa.CheckConstraint('total_quantity > 0', name='check_total_quantity_positive'),
    sa.ForeignKeyConstraint(['commodity_id'], ['commodities.id'], ondelete='RESTRICT'),
    sa.ForeignKeyConstraint(['location_id'], ['settings_locations.id'], ondelete='RESTRICT'),
    sa.ForeignKeyConstraint(['seller_branch_id'], ['partner_locations.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['seller_partner_id'], ['business_partners.id'], ondelete='RESTRICT'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_availabilities_blocked_for_branches'), 'availabilities', ['blocked_for_branches'], unique=False)
    op.create_index(op.f('ix_availabilities_commodity_id'), 'availabilities', ['commodity_id'], unique=False)
    op.create_index(op.f('ix_availabilities_country_of_origin'), 'availabilities', ['country_of_origin'], unique=False)
    op.create_index(op.f('ix_availabilities_delivery_region'), 'availabilities', ['delivery_region'], unique=False)
    op.create_index(op.f('ix_availabilities_location_id'), 'availabilities', ['location_id'], unique=False)
    op.create_index(op.f('ix_availabilities_market_visibility'), 'availabilities', ['market_visibility'], unique=False)
    op.create_index(op.f('ix_availabilities_risk_precheck_status'), 'availabilities', ['risk_precheck_status'], unique=False)
    op.create_index(op.f('ix_availabilities_seller_branch_id'), 'availabilities', ['seller_branch_id'], unique=False)
    op.create_index(op.f('ix_availabilities_seller_partner_id'), 'availabilities', ['seller_partner_id'], unique=False)
    op.create_index(op.f('ix_availabilities_status'), 'availabilities', ['status'], unique=False)
    op.create_table('device_tokens',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('user_id', sa.UUID(), nullable=False),
    sa.Column('device_type', sa.String(length=20), nullable=False),
    sa.Column('device_name', sa.String(length=255), nullable=True),
    sa.Column('device_id', sa.String(length=255), nullable=True),
    sa.Column('fcm_token', sa.String(length=255), nullable=True),
    sa.Column('apns_token', sa.String(length=255), nullable=True),
    sa.Column('web_push_subscription', sa.JSON(), nullable=True),
    sa.Column('is_active', sa.Boolean(), nullable=False),
    sa.Column('last_used_at', sa.DateTime(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_device_tokens_apns_token'), 'device_tokens', ['apns_token'], unique=True)
    op.create_index(op.f('ix_device_tokens_device_id'), 'device_tokens', ['device_id'], unique=False)
    op.create_index(op.f('ix_device_tokens_fcm_token'), 'device_tokens', ['fcm_token'], unique=True)
    op.create_index(op.f('ix_device_tokens_id'), 'device_tokens', ['id'], unique=False)
    op.create_index(op.f('ix_device_tokens_is_active'), 'device_tokens', ['is_active'], unique=False)
    op.create_index(op.f('ix_device_tokens_user_id'), 'device_tokens', ['user_id'], unique=False)
    op.create_table('notification_preferences',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('user_id', sa.UUID(), nullable=False),
    sa.Column('organization_id', sa.UUID(), nullable=False),
    sa.Column('category', sa.Enum('TRADE', 'PARTNER', 'AVAILABILITY', 'REQUIREMENT', 'PAYMENT', 'SHIPMENT', 'COMPLIANCE', 'SYSTEM', 'SECURITY', 'MARKETING', name='notificationcategory'), nullable=False),
    sa.Column('push_enabled', sa.Boolean(), nullable=False),
    sa.Column('in_app_enabled', sa.Boolean(), nullable=False),
    sa.Column('email_enabled', sa.Boolean(), nullable=False),
    sa.Column('sms_enabled', sa.Boolean(), nullable=False),
    sa.Column('websocket_enabled', sa.Boolean(), nullable=False),
    sa.Column('quiet_hours_enabled', sa.Boolean(), nullable=False),
    sa.Column('quiet_hours_start', sa.String(length=5), nullable=True),
    sa.Column('quiet_hours_end', sa.String(length=5), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.ForeignKeyConstraint(['organization_id'], ['organizations.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_notification_preferences_category'), 'notification_preferences', ['category'], unique=False)
    op.create_index(op.f('ix_notification_preferences_id'), 'notification_preferences', ['id'], unique=False)
    op.create_index(op.f('ix_notification_preferences_organization_id'), 'notification_preferences', ['organization_id'], unique=False)
    op.create_index(op.f('ix_notification_preferences_user_id'), 'notification_preferences', ['user_id'], unique=False)
    op.create_table('notifications',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('user_id', sa.UUID(), nullable=False),
    sa.Column('organization_id', sa.UUID(), nullable=False),
    sa.Column('type', sa.Enum('PUSH', 'IN_APP', 'EMAIL', 'SMS', 'WEBSOCKET', name='notificationtype'), nullable=False),
    sa.Column('category', sa.Enum('TRADE', 'PARTNER', 'AVAILABILITY', 'REQUIREMENT', 'PAYMENT', 'SHIPMENT', 'COMPLIANCE', 'SYSTEM', 'SECURITY', 'MARKETING', name='notificationcategory'), nullable=False),
    sa.Column('priority', sa.Enum('LOW', 'NORMAL', 'HIGH', 'URGENT', name='notificationpriority'), nullable=False),
    sa.Column('status', sa.Enum('PENDING', 'SENT', 'DELIVERED', 'READ', 'FAILED', 'CANCELLED', name='notificationstatus'), nullable=False),
    sa.Column('title', sa.String(length=255), nullable=False),
    sa.Column('body', sa.Text(), nullable=False),
    sa.Column('image_url', sa.String(length=512), nullable=True),
    sa.Column('icon', sa.String(length=50), nullable=True),
    sa.Column('action_url', sa.String(length=512), nullable=True),
    sa.Column('action_label', sa.String(length=100), nullable=True),
    sa.Column('action_data', sa.JSON(), nullable=True),
    sa.Column('sent_at', sa.DateTime(), nullable=True),
    sa.Column('delivered_at', sa.DateTime(), nullable=True),
    sa.Column('read_at', sa.DateTime(), nullable=True),
    sa.Column('failed_at', sa.DateTime(), nullable=True),
    sa.Column('failure_reason', sa.Text(), nullable=True),
    sa.Column('fcm_token', sa.String(length=255), nullable=True),
    sa.Column('apns_token', sa.String(length=255), nullable=True),
    sa.Column('push_response', sa.JSON(), nullable=True),
    sa.Column('email_address', sa.String(length=255), nullable=True),
    sa.Column('email_message_id', sa.String(length=255), nullable=True),
    sa.Column('phone_number', sa.String(length=20), nullable=True),
    sa.Column('sms_message_id', sa.String(length=255), nullable=True),
    sa.Column('notification_metadata', sa.JSON(), nullable=True),
    sa.Column('expires_at', sa.DateTime(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.ForeignKeyConstraint(['organization_id'], ['organizations.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_notifications_category'), 'notifications', ['category'], unique=False)
    op.create_index(op.f('ix_notifications_created_at'), 'notifications', ['created_at'], unique=False)
    op.create_index(op.f('ix_notifications_id'), 'notifications', ['id'], unique=False)
    op.create_index(op.f('ix_notifications_organization_id'), 'notifications', ['organization_id'], unique=False)
    op.create_index(op.f('ix_notifications_priority'), 'notifications', ['priority'], unique=False)
    op.create_index(op.f('ix_notifications_read_at'), 'notifications', ['read_at'], unique=False)
    op.create_index(op.f('ix_notifications_status'), 'notifications', ['status'], unique=False)
    op.create_index(op.f('ix_notifications_type'), 'notifications', ['type'], unique=False)
    op.create_index(op.f('ix_notifications_user_id'), 'notifications', ['user_id'], unique=False)
    op.create_table('organization_document_series',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('organization_id', sa.UUID(), nullable=False),
    sa.Column('financial_year_id', sa.UUID(), nullable=False),
    sa.Column('document_type', sa.String(length=64), nullable=False),
    sa.Column('prefix', sa.String(length=32), nullable=True),
    sa.Column('current_number', sa.Integer(), nullable=False),
    sa.Column('reset_annually', sa.Boolean(), nullable=False),
    sa.Column('is_active', sa.Boolean(), nullable=False),
    sa.Column('extra_config', postgresql.JSONB(astext_type=sa.Text()), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['financial_year_id'], ['organization_financial_years.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['organization_id'], ['organizations.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('organization_id', 'document_type', 'financial_year_id', name='uq_org_doc_series')
    )
    op.create_table('partner_employees',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('partner_id', sa.UUID(), nullable=False),
    sa.Column('user_id', sa.UUID(), nullable=False),
    sa.Column('employee_name', sa.String(length=200), nullable=False),
    sa.Column('employee_email', sa.String(length=200), nullable=False),
    sa.Column('employee_phone', sa.String(length=20), nullable=False),
    sa.Column('designation', sa.String(length=100), nullable=True),
    sa.Column('role', sa.String(length=20), nullable=True, comment='admin (partner owner), employee'),
    sa.Column('permissions', postgresql.JSON(astext_type=sa.Text()), nullable=True, comment='{"create_orders": true, "view_reports": true, "approve_contracts": false}'),
    sa.Column('status', sa.String(length=20), nullable=True),
    sa.Column('invited_at', sa.DateTime(timezone=True), server_default=sa.text('NOW()'), nullable=True),
    sa.Column('activated_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['partner_id'], ['business_partners.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('partner_onboarding_applications',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('user_id', sa.UUID(), nullable=False),
    sa.Column('organization_id', sa.UUID(), nullable=True, comment='Auto-defaults to main company - used to track which company processed onboarding'),
    sa.Column('service_provider_type', sa.String(length=50), nullable=True),
    sa.Column('entity_class', sa.String(length=20), nullable=True, comment='business_entity or service_provider'),
    sa.Column('capabilities', postgresql.JSON(astext_type=sa.Text()), nullable=True, comment='Trading capabilities from CDPS'),
    sa.Column('legal_name', sa.String(length=500), nullable=False),
    sa.Column('trade_name', sa.String(length=500), nullable=True),
    sa.Column('country', sa.String(length=100), nullable=False),
    sa.Column('business_entity_type', sa.String(length=100), nullable=True),
    sa.Column('registration_date', sa.Date(), nullable=True),
    sa.Column('has_tax_registration', sa.Boolean(), nullable=True),
    sa.Column('tax_id_type', sa.String(length=20), nullable=True),
    sa.Column('tax_id_number', sa.String(length=50), nullable=True),
    sa.Column('tax_details', postgresql.JSON(astext_type=sa.Text()), nullable=True),
    sa.Column('tax_verified', sa.Boolean(), nullable=True),
    sa.Column('pan_number', sa.String(length=10), nullable=True),
    sa.Column('pan_name', sa.String(length=500), nullable=True),
    sa.Column('pan_verified', sa.Boolean(), nullable=True),
    sa.Column('has_no_gst_declaration', sa.Boolean(), nullable=True),
    sa.Column('no_gst_declaration_url', sa.String(length=1000), nullable=True),
    sa.Column('declaration_reason', sa.String(length=200), nullable=True),
    sa.Column('bank_account_name', sa.String(length=200), nullable=False),
    sa.Column('bank_name', sa.String(length=200), nullable=False),
    sa.Column('bank_account_number', sa.String(length=100), nullable=False),
    sa.Column('bank_routing_code', sa.String(length=50), nullable=False),
    sa.Column('primary_address', sa.Text(), nullable=False),
    sa.Column('primary_city', sa.String(length=100), nullable=False),
    sa.Column('primary_state', sa.String(length=100), nullable=True),
    sa.Column('primary_postal_code', sa.String(length=20), nullable=False),
    sa.Column('primary_country', sa.String(length=100), nullable=False),
    sa.Column('primary_latitude', sa.Numeric(precision=10, scale=7), nullable=True),
    sa.Column('primary_longitude', sa.Numeric(precision=10, scale=7), nullable=True),
    sa.Column('primary_contact_name', sa.String(length=200), nullable=False),
    sa.Column('primary_contact_email', sa.String(length=200), nullable=False),
    sa.Column('primary_contact_phone', sa.String(length=20), nullable=False),
    sa.Column('primary_currency', sa.String(length=3), nullable=False),
    sa.Column('commodities', postgresql.JSON(astext_type=sa.Text()), nullable=True),
    sa.Column('service_details', postgresql.JSON(astext_type=sa.Text()), nullable=True),
    sa.Column('onboarding_stage', sa.String(length=50), nullable=True, comment='documents, verification, approval'),
    sa.Column('chat_transcript', postgresql.JSON(astext_type=sa.Text()), nullable=True),
    sa.Column('verification_results', postgresql.JSON(astext_type=sa.Text()), nullable=True),
    sa.Column('risk_score', sa.Integer(), nullable=True),
    sa.Column('risk_category', sa.String(length=20), nullable=True),
    sa.Column('risk_assessment', postgresql.JSON(astext_type=sa.Text()), nullable=True),
    sa.Column('status', sa.String(length=20), nullable=True),
    sa.Column('rejection_reason', sa.Text(), nullable=True),
    sa.Column('converted_to_partner_id', sa.UUID(), nullable=True),
    sa.Column('converted_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('NOW()'), nullable=True),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['organization_id'], ['organizations.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_partner_onboarding_applications_organization_id'), 'partner_onboarding_applications', ['organization_id'], unique=False)
    op.create_table('refresh_tokens',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('user_id', sa.UUID(), nullable=False),
    sa.Column('jti', sa.String(length=64), nullable=False),
    sa.Column('expires_at', sa.DateTime(timezone=True), nullable=False),
    sa.Column('revoked', sa.Boolean(), nullable=False),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('jti')
    )
    op.create_table('requirements',
    sa.Column('id', sa.UUID(), server_default=sa.text('gen_random_uuid()'), nullable=False, comment='Unique requirement identifier'),
    sa.Column('requirement_number', sa.String(length=50), nullable=False, comment='Human-readable requirement number: REQ-2025-000001'),
    sa.Column('buyer_partner_id', sa.UUID(), nullable=False, comment='Buyer posting the requirement'),
    sa.Column('commodity_id', sa.UUID(), nullable=False, comment='Required commodity'),
    sa.Column('variety_id', sa.UUID(), nullable=True, comment='Specific variety (optional)'),
    sa.Column('created_by_user_id', sa.UUID(), nullable=False, comment='User who created requirement'),
    sa.Column('min_quantity', sa.Numeric(precision=15, scale=3), nullable=False, comment='Minimum acceptable quantity'),
    sa.Column('max_quantity', sa.Numeric(precision=15, scale=3), nullable=False, comment='Maximum desired quantity'),
    sa.Column('quantity_unit', sa.String(length=20), nullable=False, comment='Unit: bales, kg, MT, grams, etc.'),
    sa.Column('preferred_quantity', sa.Numeric(precision=15, scale=3), nullable=True, comment='Ideal/target quantity'),
    sa.Column('quality_requirements', postgresql.JSONB(astext_type=sa.Text()), nullable=False, comment='Quality params with min/max/preferred/exact/accepted/required'),
    sa.Column('max_budget_per_unit', sa.Numeric(precision=15, scale=2), nullable=False, comment='Maximum price buyer willing to pay per unit'),
    sa.Column('preferred_price_per_unit', sa.Numeric(precision=15, scale=2), nullable=True, comment='Target/desired price per unit'),
    sa.Column('total_budget', sa.Numeric(precision=18, scale=2), nullable=True, comment='Overall budget limit for entire purchase'),
    sa.Column('currency_code', sa.String(length=3), server_default='INR', nullable=False, comment='Currency code (ISO 4217)'),
    sa.Column('estimated_trade_value', sa.Numeric(precision=18, scale=2), nullable=True, comment='Auto-calculated estimated trade value (preferred_quantity * max_budget_per_unit)'),
    sa.Column('buyer_credit_limit_remaining', sa.Numeric(precision=18, scale=2), nullable=True, comment='Remaining credit limit for this buyer from credit module'),
    sa.Column('buyer_exposure_after_trade', sa.Numeric(precision=18, scale=2), nullable=True, comment='Projected buyer exposure if this trade executes'),
    sa.Column('risk_precheck_status', sa.String(length=20), nullable=True, comment='PASS, WARN, FAIL - Risk assessment status'),
    sa.Column('risk_precheck_score', sa.Integer(), nullable=True, comment='Numeric risk score (0-100, higher is better)'),
    sa.Column('buyer_branch_id', sa.UUID(), nullable=True, comment='Buyer branch/location ID (from partner_locations table) for internal trade blocking logic'),
    sa.Column('blocked_internal_trades', sa.Boolean(), server_default='true', nullable=False, comment='If true, blocks matching with same branch sellers'),
    sa.Column('buyer_rating_score', sa.Numeric(precision=3, scale=2), nullable=True, comment='Buyer rating score (0.00-5.00) from rating module'),
    sa.Column('buyer_payment_performance_score', sa.Integer(), nullable=True, comment='Payment performance score (0-100) based on history'),
    sa.Column('preferred_payment_terms', postgresql.JSONB(astext_type=sa.Text()), nullable=True, comment='Array of acceptable payment term IDs'),
    sa.Column('preferred_delivery_terms', postgresql.JSONB(astext_type=sa.Text()), nullable=True, comment='Array of acceptable delivery term IDs'),
    sa.Column('delivery_locations', postgresql.JSONB(astext_type=sa.Text()), nullable=True, comment='Multiple acceptable delivery locations with proximity'),
    sa.Column('destination_country', sa.String(length=2), nullable=True, comment='ISO 3166-1 alpha-2 country code for import destination (IN, US, CN, etc.)'),
    sa.Column('preferred_incoterm', sa.String(length=10), nullable=True, comment='Preferred Incoterm for international trade: FOB, CIF, EXW, DDP, etc.'),
    sa.Column('import_port', sa.String(length=255), nullable=True, comment='Port code for international imports (e.g., INNSA for Nhava Sheva)'),
    sa.Column('delivery_window_start', sa.DateTime(timezone=True), nullable=True, comment='Earliest acceptable delivery date'),
    sa.Column('delivery_window_end', sa.DateTime(timezone=True), nullable=True, comment='Latest acceptable delivery date'),
    sa.Column('delivery_flexibility_hours', sa.Integer(), server_default='168', nullable=False, comment='Flexibility window in hours (default: 7 days = 168 hours)'),
    sa.Column('market_visibility', sa.String(length=20), server_default='PUBLIC', nullable=False, comment='PUBLIC, PRIVATE, RESTRICTED, INTERNAL'),
    sa.Column('invited_seller_ids', postgresql.JSONB(astext_type=sa.Text()), nullable=True, comment='Array of seller partner IDs for RESTRICTED visibility'),
    sa.Column('status', sa.String(length=20), server_default='DRAFT', nullable=False, comment='DRAFT, ACTIVE, PARTIALLY_FULFILLED, FULFILLED, EXPIRED, CANCELLED'),
    sa.Column('valid_from', sa.DateTime(timezone=True), nullable=False, comment='Requirement valid from date'),
    sa.Column('valid_until', sa.DateTime(timezone=True), nullable=False, comment='Requirement valid until date'),
    sa.Column('eod_cutoff', sa.DateTime(timezone=True), nullable=True, comment='End-of-day cutoff time (timezone-aware). Requirement expires at this time.'),
    sa.Column('urgency_level', sa.String(length=20), server_default='NORMAL', nullable=False, comment='URGENT, NORMAL, PLANNING'),
    sa.Column('intent_type', sa.String(length=30), server_default='DIRECT_BUY', nullable=False, comment='DIRECT_BUY, NEGOTIATION, AUCTION_REQUEST, PRICE_DISCOVERY_ONLY'),
    sa.Column('total_matched_quantity', sa.Numeric(precision=15, scale=3), server_default='0', nullable=False, comment='Total quantity matched with availabilities'),
    sa.Column('total_purchased_quantity', sa.Numeric(precision=15, scale=3), server_default='0', nullable=False, comment='Total quantity actually purchased'),
    sa.Column('total_spent', sa.Numeric(precision=18, scale=2), server_default='0', nullable=False, comment='Total amount spent on purchases'),
    sa.Column('active_negotiation_count', sa.Integer(), server_default='0', nullable=False, comment='Number of active negotiations'),
    sa.Column('market_context_embedding', postgresql.ARRAY(sa.Float()), nullable=True, comment='1536-dim vector for semantic matching (OpenAI ada-002 compatible)'),
    sa.Column('ai_suggested_max_price', sa.Numeric(precision=15, scale=2), nullable=True, comment='AI-suggested fair market price'),
    sa.Column('ai_confidence_score', sa.Integer(), nullable=True, comment='AI confidence in price suggestion (0-100)'),
    sa.Column('ai_score_vector', postgresql.JSONB(astext_type=sa.Text()), nullable=True, comment='ML embeddings for smart matching'),
    sa.Column('ai_price_alert_flag', sa.Boolean(), server_default='false', nullable=False, comment='True if AI detects unrealistic budget'),
    sa.Column('ai_alert_reason', sa.Text(), nullable=True, comment='Reason for AI price alert'),
    sa.Column('ai_recommended_sellers', postgresql.JSONB(astext_type=sa.Text()), nullable=True, comment='AI pre-scored seller suggestions'),
    sa.Column('commodity_equivalents', postgresql.JSONB(astext_type=sa.Text()), nullable=True, comment='Acceptable commodity substitutions with conversion ratios'),
    sa.Column('negotiation_preferences', postgresql.JSONB(astext_type=sa.Text()), nullable=True, comment='Self-negotiation settings and thresholds'),
    sa.Column('buyer_priority_score', sa.Float(), server_default='1.0', nullable=False, comment='Buyer priority/trust score (0.5=new, 1.0=standard, 1.5=repeat, 2.0=premium)'),
    sa.Column('notes', sa.Text(), nullable=True, comment='Buyer internal notes'),
    sa.Column('attachments', postgresql.JSONB(astext_type=sa.Text()), nullable=True, comment='Specifications, drawings, sample images'),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('NOW()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('NOW()'), nullable=False),
    sa.Column('published_at', sa.DateTime(timezone=True), nullable=True, comment='When requirement was made ACTIVE'),
    sa.Column('cancelled_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('cancelled_by_user_id', sa.UUID(), nullable=True),
    sa.Column('cancellation_reason', sa.Text(), nullable=True),
    sa.ForeignKeyConstraint(['buyer_branch_id'], ['partner_locations.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['buyer_partner_id'], ['business_partners.id'], ondelete='RESTRICT'),
    sa.ForeignKeyConstraint(['cancelled_by_user_id'], ['users.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['commodity_id'], ['commodities.id'], ondelete='RESTRICT'),
    sa.ForeignKeyConstraint(['created_by_user_id'], ['users.id'], ondelete='RESTRICT'),
    sa.ForeignKeyConstraint(['variety_id'], ['commodity_varieties.id'], ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('requirement_number')
    )
    op.create_index(op.f('ix_requirements_buyer_branch_id'), 'requirements', ['buyer_branch_id'], unique=False)
    op.create_index(op.f('ix_requirements_buyer_partner_id'), 'requirements', ['buyer_partner_id'], unique=False)
    op.create_index(op.f('ix_requirements_commodity_id'), 'requirements', ['commodity_id'], unique=False)
    op.create_index(op.f('ix_requirements_destination_country'), 'requirements', ['destination_country'], unique=False)
    op.create_table('role_capabilities',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('role_id', sa.UUID(), nullable=False),
    sa.Column('capability_id', sa.UUID(), nullable=False),
    sa.Column('granted_at', sa.DateTime(timezone=True), server_default=sa.text('NOW()'), nullable=False),
    sa.Column('granted_by', sa.UUID(), nullable=True),
    sa.ForeignKeyConstraint(['capability_id'], ['capabilities.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['granted_by'], ['users.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['role_id'], ['roles.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('role_id', 'capability_id', name='uq_role_capability')
    )
    op.create_index(op.f('ix_role_capabilities_capability_id'), 'role_capabilities', ['capability_id'], unique=False)
    op.create_index(op.f('ix_role_capabilities_role_id'), 'role_capabilities', ['role_id'], unique=False)
    op.create_table('user_capabilities',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('user_id', sa.UUID(), nullable=False),
    sa.Column('capability_id', sa.UUID(), nullable=False),
    sa.Column('granted_at', sa.DateTime(timezone=True), server_default=sa.text('NOW()'), nullable=False),
    sa.Column('granted_by', sa.UUID(), nullable=True),
    sa.Column('expires_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('revoked_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('reason', sa.Text(), nullable=True),
    sa.ForeignKeyConstraint(['capability_id'], ['capabilities.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['granted_by'], ['users.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('user_id', 'capability_id', name='uq_user_capability')
    )
    op.create_index(op.f('ix_user_capabilities_capability_id'), 'user_capabilities', ['capability_id'], unique=False)
    op.create_index(op.f('ix_user_capabilities_expires_at'), 'user_capabilities', ['expires_at'], unique=False)
    op.create_index(op.f('ix_user_capabilities_user_id'), 'user_capabilities', ['user_id'], unique=False)
    op.create_table('user_roles',
    sa.Column('user_id', sa.UUID(), nullable=False),
    sa.Column('role_id', sa.UUID(), nullable=False),
    sa.ForeignKeyConstraint(['role_id'], ['roles.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('user_id', 'role_id'),
    sa.UniqueConstraint('user_id', 'role_id', name='uq_user_role')
    )
    op.create_table('availability_embeddings',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('availability_id', sa.UUID(), nullable=False),
    sa.Column('embedding', pgvector.sqlalchemy.Vector(dim=384), nullable=False, comment='384-dim vector from Sentence-BERT'),
    sa.Column('text_hash', sa.String(length=64), nullable=False, comment='SHA-256 hash of source text to detect changes'),
    sa.Column('model_version', sa.String(length=50), server_default='all-MiniLM-L6-v2', nullable=False, comment='Embedding model version'),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='When embedding was created'),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='When embedding was last updated'),
    sa.ForeignKeyConstraint(['availability_id'], ['availabilities.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_availability_embeddings_availability_id'), 'availability_embeddings', ['availability_id'], unique=True)
    op.create_index(op.f('ix_availability_embeddings_text_hash'), 'availability_embeddings', ['text_hash'], unique=False)
    op.create_table('match_tokens',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('token', sa.String(length=32), nullable=False, comment='Anonymous token shown to users (e.g., MATCH-A7B2C)'),
    sa.Column('requirement_id', sa.UUID(), nullable=False, comment='Buyer requirement ID (hidden)'),
    sa.Column('availability_id', sa.UUID(), nullable=False, comment='Seller availability ID (hidden)'),
    sa.Column('match_score', sa.String(length=10), nullable=False, comment='Match score (0.00-1.00) as string for JSON'),
    sa.Column('disclosed_to_buyer', sa.String(length=20), nullable=False, comment='Disclosure level for buyer: MATCHED, NEGOTIATING, TRADE'),
    sa.Column('disclosed_to_seller', sa.String(length=20), nullable=False, comment='Disclosure level for seller: MATCHED, NEGOTIATING, TRADE'),
    sa.Column('negotiation_started_at', sa.DateTime(), nullable=True, comment='When negotiation began and identities were revealed'),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('expires_at', sa.DateTime(), nullable=False, comment='Token expires after 30 days if no negotiation'),
    sa.ForeignKeyConstraint(['availability_id'], ['availabilities.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['requirement_id'], ['requirements.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('idx_match_tokens_availability', 'match_tokens', ['availability_id'], unique=False)
    op.create_index('idx_match_tokens_expires', 'match_tokens', ['expires_at'], unique=False)
    op.create_index('idx_match_tokens_requirement', 'match_tokens', ['requirement_id'], unique=False)
    op.create_index(op.f('ix_match_tokens_token'), 'match_tokens', ['token'], unique=True)
    op.create_table('requirement_embeddings',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('requirement_id', sa.UUID(), nullable=False),
    sa.Column('embedding', pgvector.sqlalchemy.Vector(dim=384), nullable=False, comment='384-dim vector from Sentence-BERT'),
    sa.Column('text_hash', sa.String(length=64), nullable=False, comment='SHA-256 hash of source text to detect changes'),
    sa.Column('model_version', sa.String(length=50), server_default='all-MiniLM-L6-v2', nullable=False, comment='Embedding model version'),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='When embedding was created'),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='When embedding was last updated'),
    sa.ForeignKeyConstraint(['requirement_id'], ['requirements.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_requirement_embeddings_requirement_id'), 'requirement_embeddings', ['requirement_id'], unique=True)
    op.create_index(op.f('ix_requirement_embeddings_text_hash'), 'requirement_embeddings', ['text_hash'], unique=False)
    op.create_table('negotiations',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('match_token_id', sa.UUID(), nullable=False, comment='Anonymous match token that initiated this negotiation'),
    sa.Column('requirement_id', sa.UUID(), nullable=False, comment='Buyer requirement ID'),
    sa.Column('availability_id', sa.UUID(), nullable=False, comment='Seller availability ID'),
    sa.Column('buyer_partner_id', sa.UUID(), nullable=False, comment='Buyer partner ID'),
    sa.Column('seller_partner_id', sa.UUID(), nullable=False, comment='Seller partner ID'),
    sa.Column('status', sa.String(length=20), nullable=False, comment='INITIATED, IN_PROGRESS, ACCEPTED, REJECTED, EXPIRED'),
    sa.Column('current_round', sa.Integer(), nullable=False, comment='Current round number (increments with each offer)'),
    sa.Column('current_price_per_unit', sa.Numeric(precision=15, scale=2), nullable=True, comment='Current price being negotiated'),
    sa.Column('current_quantity', sa.Numeric(precision=15, scale=3), nullable=True, comment='Current quantity being negotiated'),
    sa.Column('current_terms', postgresql.JSONB(astext_type=sa.Text()), nullable=True, comment='Current negotiation terms (delivery, payment, quality)'),
    sa.Column('initiated_by', sa.String(length=10), nullable=False, comment='BUYER or SELLER (who started negotiation)'),
    sa.Column('last_offer_by', sa.String(length=10), nullable=True, comment='BUYER or SELLER (who made last offer)'),
    sa.Column('initiated_at', sa.DateTime(), nullable=False, comment='When negotiation started'),
    sa.Column('last_activity_at', sa.DateTime(), nullable=False, comment='Last activity timestamp (for expiration)'),
    sa.Column('expires_at', sa.DateTime(), nullable=False, comment='Auto-expire if no activity (default 48 hours)'),
    sa.Column('accepted_by', sa.String(length=10), nullable=True, comment='BUYER or SELLER (who accepted the deal)'),
    sa.Column('accepted_at', sa.DateTime(), nullable=True, comment='When deal was accepted'),
    sa.Column('rejected_by', sa.String(length=10), nullable=True, comment='BUYER or SELLER (who rejected)'),
    sa.Column('rejected_at', sa.DateTime(), nullable=True, comment='When deal was rejected'),
    sa.Column('rejection_reason', sa.String(length=500), nullable=True, comment='Reason for rejection'),
    sa.Column('expired_at', sa.DateTime(), nullable=True, comment='When negotiation expired'),
    sa.Column('ai_suggestions_enabled', sa.Boolean(), nullable=False, comment='Allow AI to suggest counter-offers'),
    sa.Column('auto_negotiate_buyer', sa.Boolean(), nullable=False, comment="Allow AI to negotiate on buyer's behalf"),
    sa.Column('auto_negotiate_seller', sa.Boolean(), nullable=False, comment="Allow AI to negotiate on seller's behalf"),
    sa.Column('trade_id', sa.UUID(), nullable=True, comment='Trade contract created if accepted (FK to trades.id)'),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.CheckConstraint("accepted_by IS NULL OR accepted_by IN ('BUYER', 'SELLER')", name='check_accepted_by'),
    sa.CheckConstraint("initiated_by IN ('BUYER', 'SELLER')", name='check_initiated_by'),
    sa.CheckConstraint("last_offer_by IS NULL OR last_offer_by IN ('BUYER', 'SELLER')", name='check_last_offer_by'),
    sa.CheckConstraint("rejected_by IS NULL OR rejected_by IN ('BUYER', 'SELLER')", name='check_rejected_by'),
    sa.CheckConstraint("status IN ('INITIATED', 'IN_PROGRESS', 'ACCEPTED', 'REJECTED', 'EXPIRED')", name='check_negotiation_status'),
    sa.CheckConstraint('current_price_per_unit IS NULL OR current_price_per_unit > 0', name='check_price_positive'),
    sa.CheckConstraint('current_quantity IS NULL OR current_quantity > 0', name='check_quantity_positive'),
    sa.CheckConstraint('current_round >= 0', name='check_current_round_non_negative'),
    sa.ForeignKeyConstraint(['availability_id'], ['availabilities.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['buyer_partner_id'], ['business_partners.id'], ),
    sa.ForeignKeyConstraint(['match_token_id'], ['match_tokens.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['requirement_id'], ['requirements.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['seller_partner_id'], ['business_partners.id'], ),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('match_token_id')
    )
    op.create_index('idx_negotiations_availability', 'negotiations', ['availability_id'], unique=False)
    op.create_index('idx_negotiations_buyer', 'negotiations', ['buyer_partner_id'], unique=False)
    op.create_index('idx_negotiations_expires', 'negotiations', ['expires_at'], unique=False)
    op.create_index('idx_negotiations_match_token', 'negotiations', ['match_token_id'], unique=False)
    op.create_index('idx_negotiations_requirement', 'negotiations', ['requirement_id'], unique=False)
    op.create_index('idx_negotiations_seller', 'negotiations', ['seller_partner_id'], unique=False)
    op.create_index('idx_negotiations_status', 'negotiations', ['status'], unique=False)
    op.create_table('negotiation_messages',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('negotiation_id', sa.UUID(), nullable=False, comment='Parent negotiation session'),
    sa.Column('sender', sa.String(length=10), nullable=False, comment='BUYER, SELLER, SYSTEM, AI_BOT'),
    sa.Column('message', sa.Text(), nullable=False, comment='Message text'),
    sa.Column('message_type', sa.String(length=20), nullable=False, comment='TEXT, OFFER, ACCEPTANCE, REJECTION, SYSTEM, AI_SUGGESTION'),
    sa.Column('is_ai_generated', sa.Boolean(), nullable=False, comment='Was this generated by AI?'),
    sa.Column('read_by_buyer', sa.Boolean(), nullable=False, comment='Has buyer read this message?'),
    sa.Column('read_by_seller', sa.Boolean(), nullable=False, comment='Has seller read this message?'),
    sa.Column('read_by_buyer_at', sa.DateTime(), nullable=True, comment='When buyer read the message'),
    sa.Column('read_by_seller_at', sa.DateTime(), nullable=True, comment='When seller read the message'),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.CheckConstraint("message_type IN ('TEXT', 'OFFER', 'ACCEPTANCE', 'REJECTION', 'SYSTEM', 'AI_SUGGESTION')", name='check_message_type'),
    sa.CheckConstraint("sender IN ('BUYER', 'SELLER', 'SYSTEM', 'AI_BOT')", name='check_message_sender'),
    sa.ForeignKeyConstraint(['negotiation_id'], ['negotiations.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('idx_messages_created', 'negotiation_messages', ['created_at'], unique=False)
    op.create_index('idx_messages_negotiation', 'negotiation_messages', ['negotiation_id'], unique=False)
    op.create_index('idx_messages_unread_buyer', 'negotiation_messages', ['negotiation_id', 'read_by_buyer'], unique=False)
    op.create_index('idx_messages_unread_seller', 'negotiation_messages', ['negotiation_id', 'read_by_seller'], unique=False)
    op.create_table('negotiation_offers',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('negotiation_id', sa.UUID(), nullable=False, comment='Parent negotiation session'),
    sa.Column('round_number', sa.Integer(), nullable=False, comment='Sequential round number (1, 2, 3...)'),
    sa.Column('offered_by', sa.String(length=10), nullable=False, comment='BUYER or SELLER'),
    sa.Column('price_per_unit', sa.Numeric(precision=15, scale=2), nullable=False, comment='Offered price per unit'),
    sa.Column('quantity', sa.Numeric(precision=15, scale=3), nullable=False, comment='Offered quantity'),
    sa.Column('delivery_terms', postgresql.JSONB(astext_type=sa.Text()), nullable=True, comment='Delivery location, timeline, Incoterms'),
    sa.Column('payment_terms', postgresql.JSONB(astext_type=sa.Text()), nullable=True, comment='Payment method, timeline, advance percentage'),
    sa.Column('quality_conditions', postgresql.JSONB(astext_type=sa.Text()), nullable=True, comment='Quality parameters and acceptance criteria'),
    sa.Column('message', sa.Text(), nullable=True, comment='Human or AI-written message accompanying offer'),
    sa.Column('ai_generated', sa.Boolean(), nullable=False, comment='Was this offer suggested by AI?'),
    sa.Column('ai_confidence', sa.Numeric(precision=3, scale=2), nullable=True, comment='AI confidence score (0.00-1.00) if AI-generated'),
    sa.Column('ai_reasoning', sa.Text(), nullable=True, comment='AI explanation for this offer'),
    sa.Column('status', sa.String(length=20), nullable=False, comment='PENDING, ACCEPTED, REJECTED, COUNTERED, EXPIRED'),
    sa.Column('responded_at', sa.DateTime(), nullable=True, comment='When counterparty responded'),
    sa.Column('response_message', sa.Text(), nullable=True, comment='Response message if rejected'),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.CheckConstraint("offered_by IN ('BUYER', 'SELLER')", name='check_offer_offered_by'),
    sa.CheckConstraint("status IN ('PENDING', 'ACCEPTED', 'REJECTED', 'COUNTERED', 'EXPIRED')", name='check_offer_status'),
    sa.CheckConstraint('ai_confidence IS NULL OR (ai_confidence >= 0 AND ai_confidence <= 1)', name='check_ai_confidence_range'),
    sa.CheckConstraint('price_per_unit > 0', name='check_offer_price_positive'),
    sa.CheckConstraint('quantity > 0', name='check_offer_quantity_positive'),
    sa.CheckConstraint('round_number > 0', name='check_round_positive'),
    sa.ForeignKeyConstraint(['negotiation_id'], ['negotiations.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('idx_offers_negotiation', 'negotiation_offers', ['negotiation_id'], unique=False)
    op.create_index('idx_offers_round', 'negotiation_offers', ['negotiation_id', 'round_number'], unique=False)
    op.create_index('idx_offers_status', 'negotiation_offers', ['status'], unique=False)
    op.create_table('trades',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('trade_number', sa.String(length=50), nullable=False, comment='Unique trade number (TR-2025-00001)'),
    sa.Column('negotiation_id', sa.UUID(), nullable=False, comment='Negotiation that created this trade'),
    sa.Column('buyer_partner_id', sa.UUID(), nullable=False),
    sa.Column('seller_partner_id', sa.UUID(), nullable=False),
    sa.Column('ship_to_branch_id', sa.UUID(), nullable=True, comment='Buyer branch for delivery'),
    sa.Column('bill_to_branch_id', sa.UUID(), nullable=True, comment='Buyer branch for billing (usually same as ship-to)'),
    sa.Column('ship_from_branch_id', sa.UUID(), nullable=True, comment='Seller branch for shipment'),
    sa.Column('ship_to_address', postgresql.JSONB(astext_type=sa.Text()), nullable=False, comment='Ship-to address snapshot (frozen at trade creation)'),
    sa.Column('bill_to_address', postgresql.JSONB(astext_type=sa.Text()), nullable=False, comment='Bill-to address snapshot'),
    sa.Column('ship_from_address', postgresql.JSONB(astext_type=sa.Text()), nullable=False, comment='Ship-from address snapshot'),
    sa.Column('ship_to_address_source', sa.String(length=50), nullable=True, comment='AUTO_PRIMARY, AUTO_SINGLE_BRANCH, USER_SELECTED, DEFAULT_BRANCH'),
    sa.Column('ship_from_address_source', sa.String(length=50), nullable=True),
    sa.Column('commodity_id', sa.UUID(), nullable=False),
    sa.Column('commodity_variety_id', sa.UUID(), nullable=True),
    sa.Column('quantity', sa.Numeric(precision=15, scale=3), nullable=False, comment='Quantity in units'),
    sa.Column('unit', sa.String(length=20), nullable=False),
    sa.Column('price_per_unit', sa.Numeric(precision=15, scale=2), nullable=False),
    sa.Column('total_amount', sa.Numeric(precision=15, scale=2), nullable=False, comment='Total trade value (quantity * price)'),
    sa.Column('gst_type', sa.String(length=20), nullable=True, comment='INTRA_STATE (CGST+SGST), INTER_STATE (IGST)'),
    sa.Column('cgst_rate', sa.Numeric(precision=5, scale=2), nullable=True),
    sa.Column('sgst_rate', sa.Numeric(precision=5, scale=2), nullable=True),
    sa.Column('igst_rate', sa.Numeric(precision=5, scale=2), nullable=True),
    sa.Column('delivery_terms', sa.Text(), nullable=True),
    sa.Column('payment_terms', sa.Text(), nullable=True),
    sa.Column('quality_parameters', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column('delivery_timeline', sa.String(length=100), nullable=True),
    sa.Column('delivery_city', sa.String(length=100), nullable=True),
    sa.Column('delivery_state', sa.String(length=100), nullable=True),
    sa.Column('contract_pdf_url', sa.Text(), nullable=True, comment='S3 URL to generated contract PDF'),
    sa.Column('contract_html', sa.Text(), nullable=True, comment='Rendered HTML before PDF conversion (for amendments)'),
    sa.Column('contract_hash', sa.String(length=64), nullable=True, comment='SHA-256 hash for contract integrity verification'),
    sa.Column('contract_generated_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('status', sa.String(length=50), nullable=False, comment='Trade status'),
    sa.Column('trade_date', sa.Date(), nullable=False),
    sa.Column('expected_delivery_date', sa.Date(), nullable=True),
    sa.Column('actual_delivery_date', sa.Date(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False),
    sa.Column('created_by', sa.UUID(), nullable=True),
    sa.CheckConstraint("gst_type IN ('INTRA_STATE', 'INTER_STATE') OR gst_type IS NULL", name='ck_trades_gst_type'),
    sa.CheckConstraint("status IN (\n                'PENDING_BRANCH_SELECTION',\n                'ACTIVE',\n                'IN_TRANSIT',\n                'DELIVERED',\n                'COMPLETED',\n                'CANCELLED',\n                'DISPUTED'\n            )", name='ck_trades_status'),
    sa.CheckConstraint('price_per_unit > 0', name='ck_trades_positive_price'),
    sa.CheckConstraint('quantity > 0', name='ck_trades_positive_quantity'),
    sa.CheckConstraint('total_amount > 0', name='ck_trades_positive_total'),
    sa.ForeignKeyConstraint(['bill_to_branch_id'], ['partner_branches.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['buyer_partner_id'], ['business_partners.id'], ondelete='RESTRICT'),
    sa.ForeignKeyConstraint(['commodity_id'], ['commodities.id'], ondelete='RESTRICT'),
    sa.ForeignKeyConstraint(['commodity_variety_id'], ['commodity_varieties.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['created_by'], ['users.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['negotiation_id'], ['negotiations.id'], ondelete='RESTRICT'),
    sa.ForeignKeyConstraint(['seller_partner_id'], ['business_partners.id'], ondelete='RESTRICT'),
    sa.ForeignKeyConstraint(['ship_from_branch_id'], ['partner_branches.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['ship_to_branch_id'], ['partner_branches.id'], ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('trade_number')
    )
    op.create_index('ix_trades_buyer_partner_id', 'trades', ['buyer_partner_id'], unique=False)
    op.create_index('ix_trades_commodity_id', 'trades', ['commodity_id'], unique=False)
    op.create_index('ix_trades_negotiation_id', 'trades', ['negotiation_id'], unique=False)
    op.create_index('ix_trades_seller_partner_id', 'trades', ['seller_partner_id'], unique=False)
    op.create_index('ix_trades_status', 'trades', ['status'], unique=False)
    op.create_index('ix_trades_trade_date', 'trades', ['trade_date'], unique=False)
    op.create_index('ix_trades_trade_number', 'trades', ['trade_number'], unique=True)
    op.create_table('match_outcomes',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('requirement_id', sa.UUID(), nullable=False),
    sa.Column('availability_id', sa.UUID(), nullable=False),
    sa.Column('trade_id', sa.UUID(), nullable=True, comment='Trade created from this match (if successful)'),
    sa.Column('match_score', sa.Numeric(precision=5, scale=4), nullable=False, comment='Overall match score (0.0-1.0)'),
    sa.Column('quality_score', sa.Numeric(precision=5, scale=4), nullable=False, comment='Quality compatibility score (0.0-1.0)'),
    sa.Column('price_score', sa.Numeric(precision=5, scale=4), nullable=False, comment='Price competitiveness score (0.0-1.0)'),
    sa.Column('delivery_score', sa.Numeric(precision=5, scale=4), nullable=False, comment='Delivery logistics score (0.0-1.0)'),
    sa.Column('risk_score', sa.Numeric(precision=5, scale=4), nullable=False, comment='Risk assessment score (0.0-1.0)'),
    sa.Column('distance_km', sa.Numeric(precision=10, scale=2), nullable=True, comment='Distance between buyer and seller locations'),
    sa.Column('price_difference_pct', sa.Numeric(precision=6, scale=2), nullable=True, comment='Price diff: (availability_price - max_budget) / max_budget * 100'),
    sa.Column('negotiation_started', sa.Boolean(), nullable=False, comment='Whether negotiation was initiated'),
    sa.Column('negotiation_rounds', sa.Integer(), nullable=True, comment='Number of negotiation rounds (if applicable)'),
    sa.Column('final_price', sa.Numeric(precision=15, scale=2), nullable=True, comment='Final negotiated price per unit'),
    sa.Column('trade_completed', sa.Boolean(), nullable=False, comment='Whether trade was successfully completed'),
    sa.Column('quality_accepted', sa.Boolean(), nullable=True, comment='Whether quality was accepted on delivery'),
    sa.Column('payment_on_time', sa.Boolean(), nullable=True, comment='Whether payment was made on time'),
    sa.Column('delivery_on_time', sa.Boolean(), nullable=True, comment='Whether delivery was made on time'),
    sa.Column('buyer_satisfaction', sa.Integer(), nullable=True, comment='Buyer satisfaction rating (1-5)'),
    sa.Column('seller_satisfaction', sa.Integer(), nullable=True, comment='Seller satisfaction rating (1-5)'),
    sa.Column('additional_features', postgresql.JSONB(astext_type=sa.Text()), nullable=True, comment='Additional features for ML: commodity_id, variety_id, buyer_rating, seller_rating, etc.'),
    sa.Column('failure_reason', sa.String(length=500), nullable=True, comment='Reason for match failure (if applicable)'),
    sa.Column('matched_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='When match was created'),
    sa.Column('completed_at', sa.DateTime(timezone=True), nullable=True, comment='When trade was completed (if successful)'),
    sa.Column('failed_at', sa.DateTime(timezone=True), nullable=True, comment='When match failed (if failed)'),
    sa.ForeignKeyConstraint(['availability_id'], ['availabilities.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['requirement_id'], ['requirements.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['trade_id'], ['trades.id'], ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_match_outcomes_availability_id'), 'match_outcomes', ['availability_id'], unique=False)
    op.create_index(op.f('ix_match_outcomes_requirement_id'), 'match_outcomes', ['requirement_id'], unique=False)
    op.create_index(op.f('ix_match_outcomes_trade_id'), 'match_outcomes', ['trade_id'], unique=False)
    op.create_table('trade_amendments',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('trade_id', sa.UUID(), nullable=False),
    sa.Column('amendment_type', sa.String(length=50), nullable=False, comment='ADDRESS_CHANGE, QUANTITY_CHANGE, PRICE_CHANGE, DELIVERY_DATE_CHANGE'),
    sa.Column('field_name', sa.String(length=100), nullable=False, comment='Field that was amended (e.g., ship_to_address, quantity)'),
    sa.Column('old_value', postgresql.JSONB(astext_type=sa.Text()), nullable=False, comment='Original value before amendment'),
    sa.Column('new_value', postgresql.JSONB(astext_type=sa.Text()), nullable=False, comment='New value after amendment'),
    sa.Column('reason', sa.Text(), nullable=True, comment='Reason for amendment provided by requesting party'),
    sa.Column('requires_counterparty_approval', sa.Boolean(), nullable=False, comment='Whether counterparty approval is needed'),
    sa.Column('requested_by_party', sa.String(length=20), nullable=False, comment='BUYER or SELLER'),
    sa.Column('requested_by_user_id', sa.UUID(), nullable=False),
    sa.Column('status', sa.String(length=20), nullable=False, comment='PENDING, APPROVED, REJECTED'),
    sa.Column('approved_by_user_id', sa.UUID(), nullable=True),
    sa.Column('approved_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('rejection_reason', sa.Text(), nullable=True, comment='Reason for rejection (if rejected)'),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False),
    sa.CheckConstraint("amendment_type IN ('ADDRESS_CHANGE', 'QUANTITY_CHANGE', 'PRICE_CHANGE', 'DELIVERY_DATE_CHANGE')", name='ck_trade_amendments_type'),
    sa.CheckConstraint("requested_by_party IN ('BUYER', 'SELLER')", name='ck_trade_amendments_party'),
    sa.CheckConstraint("status IN ('PENDING', 'APPROVED', 'REJECTED')", name='ck_trade_amendments_status'),
    sa.ForeignKeyConstraint(['approved_by_user_id'], ['users.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['requested_by_user_id'], ['users.id'], ondelete='RESTRICT'),
    sa.ForeignKeyConstraint(['trade_id'], ['trades.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('ix_trade_amendments_status', 'trade_amendments', ['status'], unique=False)
    op.create_index('ix_trade_amendments_trade_id', 'trade_amendments', ['trade_id'], unique=False)
    op.create_table('trade_signatures',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('trade_id', sa.UUID(), nullable=False),
    sa.Column('partner_id', sa.UUID(), nullable=False, comment='Business partner who signed'),
    sa.Column('signed_by_user_id', sa.UUID(), nullable=False, comment='User who performed the signature'),
    sa.Column('party_type', sa.String(length=20), nullable=False, comment='BUYER or SELLER'),
    sa.Column('signature_tier', sa.String(length=20), nullable=False, comment='BASIC (Phase 1), AADHAAR_ESIGN (Phase 2), DSC (Phase 2)'),
    sa.Column('signature_image_url', sa.String(length=500), nullable=True, comment='For BASIC tier - URL to signature image (from partner profile)'),
    sa.Column('aadhaar_reference_id', sa.String(length=100), nullable=True, comment='NSDL/CDAC eSign reference ID'),
    sa.Column('aadhaar_transaction_id', sa.String(length=100), nullable=True, comment='Aadhaar eSign transaction ID'),
    sa.Column('dsc_signature_value', sa.Text(), nullable=True, comment='Encrypted digital signature value from DSC'),
    sa.Column('dsc_certificate_serial', sa.String(length=100), nullable=True, comment='DSC certificate serial number'),
    sa.Column('document_hash', sa.String(length=64), nullable=False, comment='SHA-256 hash of contract PDF that was signed'),
    sa.Column('ip_address', sa.String(length=50), nullable=True, comment='IP address from which signature was performed'),
    sa.Column('user_agent', sa.Text(), nullable=True, comment='Browser user agent string'),
    sa.Column('geolocation', sa.String(length=200), nullable=True, comment='Geolocation data (city, country)'),
    sa.Column('signed_at', sa.DateTime(timezone=True), nullable=False, comment='Timestamp when contract was signed'),
    sa.CheckConstraint("party_type IN ('BUYER', 'SELLER')", name='ck_trade_signatures_party_type'),
    sa.CheckConstraint("signature_tier IN ('BASIC', 'AADHAAR_ESIGN', 'DSC')", name='ck_trade_signatures_tier'),
    sa.ForeignKeyConstraint(['partner_id'], ['business_partners.id'], ondelete='RESTRICT'),
    sa.ForeignKeyConstraint(['signed_by_user_id'], ['users.id'], ondelete='RESTRICT'),
    sa.ForeignKeyConstraint(['trade_id'], ['trades.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('trade_id', 'partner_id', name='uq_trade_signature_per_partner')
    )
    op.create_index('ix_trade_signatures_partner_id', 'trade_signatures', ['partner_id'], unique=False)
    op.create_index('ix_trade_signatures_trade_id', 'trade_signatures', ['trade_id'], unique=False)
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index('ix_trade_signatures_trade_id', table_name='trade_signatures')
    op.drop_index('ix_trade_signatures_partner_id', table_name='trade_signatures')
    op.drop_table('trade_signatures')
    op.drop_index('ix_trade_amendments_trade_id', table_name='trade_amendments')
    op.drop_index('ix_trade_amendments_status', table_name='trade_amendments')
    op.drop_table('trade_amendments')
    op.drop_index(op.f('ix_match_outcomes_trade_id'), table_name='match_outcomes')
    op.drop_index(op.f('ix_match_outcomes_requirement_id'), table_name='match_outcomes')
    op.drop_index(op.f('ix_match_outcomes_availability_id'), table_name='match_outcomes')
    op.drop_table('match_outcomes')
    op.drop_index('ix_trades_trade_number', table_name='trades')
    op.drop_index('ix_trades_trade_date', table_name='trades')
    op.drop_index('ix_trades_status', table_name='trades')
    op.drop_index('ix_trades_seller_partner_id', table_name='trades')
    op.drop_index('ix_trades_negotiation_id', table_name='trades')
    op.drop_index('ix_trades_commodity_id', table_name='trades')
    op.drop_index('ix_trades_buyer_partner_id', table_name='trades')
    op.drop_table('trades')
    op.drop_index('idx_offers_status', table_name='negotiation_offers')
    op.drop_index('idx_offers_round', table_name='negotiation_offers')
    op.drop_index('idx_offers_negotiation', table_name='negotiation_offers')
    op.drop_table('negotiation_offers')
    op.drop_index('idx_messages_unread_seller', table_name='negotiation_messages')
    op.drop_index('idx_messages_unread_buyer', table_name='negotiation_messages')
    op.drop_index('idx_messages_negotiation', table_name='negotiation_messages')
    op.drop_index('idx_messages_created', table_name='negotiation_messages')
    op.drop_table('negotiation_messages')
    op.drop_index('idx_negotiations_status', table_name='negotiations')
    op.drop_index('idx_negotiations_seller', table_name='negotiations')
    op.drop_index('idx_negotiations_requirement', table_name='negotiations')
    op.drop_index('idx_negotiations_match_token', table_name='negotiations')
    op.drop_index('idx_negotiations_expires', table_name='negotiations')
    op.drop_index('idx_negotiations_buyer', table_name='negotiations')
    op.drop_index('idx_negotiations_availability', table_name='negotiations')
    op.drop_table('negotiations')
    op.drop_index(op.f('ix_requirement_embeddings_text_hash'), table_name='requirement_embeddings')
    op.drop_index(op.f('ix_requirement_embeddings_requirement_id'), table_name='requirement_embeddings')
    op.drop_table('requirement_embeddings')
    op.drop_index(op.f('ix_match_tokens_token'), table_name='match_tokens')
    op.drop_index('idx_match_tokens_requirement', table_name='match_tokens')
    op.drop_index('idx_match_tokens_expires', table_name='match_tokens')
    op.drop_index('idx_match_tokens_availability', table_name='match_tokens')
    op.drop_table('match_tokens')
    op.drop_index(op.f('ix_availability_embeddings_text_hash'), table_name='availability_embeddings')
    op.drop_index(op.f('ix_availability_embeddings_availability_id'), table_name='availability_embeddings')
    op.drop_table('availability_embeddings')
    op.drop_table('user_roles')
    op.drop_index(op.f('ix_user_capabilities_user_id'), table_name='user_capabilities')
    op.drop_index(op.f('ix_user_capabilities_expires_at'), table_name='user_capabilities')
    op.drop_index(op.f('ix_user_capabilities_capability_id'), table_name='user_capabilities')
    op.drop_table('user_capabilities')
    op.drop_index(op.f('ix_role_capabilities_role_id'), table_name='role_capabilities')
    op.drop_index(op.f('ix_role_capabilities_capability_id'), table_name='role_capabilities')
    op.drop_table('role_capabilities')
    op.drop_index(op.f('ix_requirements_destination_country'), table_name='requirements')
    op.drop_index(op.f('ix_requirements_commodity_id'), table_name='requirements')
    op.drop_index(op.f('ix_requirements_buyer_partner_id'), table_name='requirements')
    op.drop_index(op.f('ix_requirements_buyer_branch_id'), table_name='requirements')
    op.drop_table('requirements')
    op.drop_table('refresh_tokens')
    op.drop_index(op.f('ix_partner_onboarding_applications_organization_id'), table_name='partner_onboarding_applications')
    op.drop_table('partner_onboarding_applications')
    op.drop_table('partner_employees')
    op.drop_table('organization_document_series')
    op.drop_index(op.f('ix_notifications_user_id'), table_name='notifications')
    op.drop_index(op.f('ix_notifications_type'), table_name='notifications')
    op.drop_index(op.f('ix_notifications_status'), table_name='notifications')
    op.drop_index(op.f('ix_notifications_read_at'), table_name='notifications')
    op.drop_index(op.f('ix_notifications_priority'), table_name='notifications')
    op.drop_index(op.f('ix_notifications_organization_id'), table_name='notifications')
    op.drop_index(op.f('ix_notifications_id'), table_name='notifications')
    op.drop_index(op.f('ix_notifications_created_at'), table_name='notifications')
    op.drop_index(op.f('ix_notifications_category'), table_name='notifications')
    op.drop_table('notifications')
    op.drop_index(op.f('ix_notification_preferences_user_id'), table_name='notification_preferences')
    op.drop_index(op.f('ix_notification_preferences_organization_id'), table_name='notification_preferences')
    op.drop_index(op.f('ix_notification_preferences_id'), table_name='notification_preferences')
    op.drop_index(op.f('ix_notification_preferences_category'), table_name='notification_preferences')
    op.drop_table('notification_preferences')
    op.drop_index(op.f('ix_device_tokens_user_id'), table_name='device_tokens')
    op.drop_index(op.f('ix_device_tokens_is_active'), table_name='device_tokens')
    op.drop_index(op.f('ix_device_tokens_id'), table_name='device_tokens')
    op.drop_index(op.f('ix_device_tokens_fcm_token'), table_name='device_tokens')
    op.drop_index(op.f('ix_device_tokens_device_id'), table_name='device_tokens')
    op.drop_index(op.f('ix_device_tokens_apns_token'), table_name='device_tokens')
    op.drop_table('device_tokens')
    op.drop_index(op.f('ix_availabilities_status'), table_name='availabilities')
    op.drop_index(op.f('ix_availabilities_seller_partner_id'), table_name='availabilities')
    op.drop_index(op.f('ix_availabilities_seller_branch_id'), table_name='availabilities')
    op.drop_index(op.f('ix_availabilities_risk_precheck_status'), table_name='availabilities')
    op.drop_index(op.f('ix_availabilities_market_visibility'), table_name='availabilities')
    op.drop_index(op.f('ix_availabilities_location_id'), table_name='availabilities')
    op.drop_index(op.f('ix_availabilities_delivery_region'), table_name='availabilities')
    op.drop_index(op.f('ix_availabilities_country_of_origin'), table_name='availabilities')
    op.drop_index(op.f('ix_availabilities_commodity_id'), table_name='availabilities')
    op.drop_index(op.f('ix_availabilities_blocked_for_branches'), table_name='availabilities')
    op.drop_table('availabilities')
    op.drop_index(op.f('ix_users_mobile_number'), table_name='users')
    op.drop_table('users')
    op.drop_index(op.f('ix_user_consents_user_id'), table_name='user_consents')
    op.drop_index(op.f('ix_user_consents_consent_type'), table_name='user_consents')
    op.drop_table('user_consents')
    op.drop_table('role_permissions')
    op.drop_index(op.f('ix_partner_vehicles_vehicle_number'), table_name='partner_vehicles')
    op.drop_table('partner_vehicles')
    op.drop_table('partner_locations')
    op.drop_table('partner_kyc_renewals')
    op.drop_table('partner_documents')
    op.drop_index(op.f('ix_partner_branches_state'), table_name='partner_branches')
    op.drop_index(op.f('ix_partner_branches_partner_id'), table_name='partner_branches')
    op.drop_index(op.f('ix_partner_branches_city'), table_name='partner_branches')
    op.drop_table('partner_branches')
    op.drop_table('partner_amendments')
    op.drop_table('organization_gst')
    op.drop_table('organization_financial_years')
    op.drop_table('organization_bank_accounts')
    op.drop_table('commodity_varieties')
    op.drop_table('commodity_parameters')
    op.drop_table('commission_structures')
    op.drop_table('weightment_terms')
    op.drop_index(op.f('ix_user_sessions_user_id'), table_name='user_sessions')
    op.drop_index(op.f('ix_user_sessions_refresh_token_jti'), table_name='user_sessions')
    op.drop_index(op.f('ix_user_sessions_refresh_token_expires_at'), table_name='user_sessions')
    op.drop_index(op.f('ix_user_sessions_last_active_at'), table_name='user_sessions')
    op.drop_index(op.f('ix_user_sessions_is_active'), table_name='user_sessions')
    op.drop_index(op.f('ix_user_sessions_device_fingerprint'), table_name='user_sessions')
    op.drop_table('user_sessions')
    op.drop_index(op.f('ix_user_right_requests_user_id'), table_name='user_right_requests')
    op.drop_table('user_right_requests')
    op.drop_table('trade_types')
    op.drop_index(op.f('ix_system_commodity_parameters_commodity_category'), table_name='system_commodity_parameters')
    op.drop_table('system_commodity_parameters')
    op.drop_index('ix_settings_locations_state', table_name='settings_locations')
    op.drop_index('ix_settings_locations_region', table_name='settings_locations')
    op.drop_index('ix_settings_locations_pincode', table_name='settings_locations')
    op.drop_index('ix_settings_locations_is_active', table_name='settings_locations')
    op.drop_index('ix_settings_locations_google_place_id', table_name='settings_locations')
    op.drop_index('ix_settings_locations_city', table_name='settings_locations')
    op.drop_table('settings_locations')
    op.drop_table('roles')
    op.drop_table('permissions')
    op.drop_table('payment_terms')
    op.drop_table('passing_terms')
    op.drop_table('organizations')
    op.drop_index(op.f('ix_hsn_knowledge_base_hsn_code'), table_name='hsn_knowledge_base')
    op.drop_index(op.f('ix_hsn_knowledge_base_commodity_name'), table_name='hsn_knowledge_base')
    op.drop_index(op.f('ix_hsn_knowledge_base_commodity_category'), table_name='hsn_knowledge_base')
    op.drop_table('hsn_knowledge_base')
    op.drop_index(op.f('ix_events_user_id'), table_name='events')
    op.drop_index(op.f('ix_events_timestamp'), table_name='events')
    op.drop_index(op.f('ix_events_event_type'), table_name='events')
    op.drop_index(op.f('ix_events_aggregate_type'), table_name='events')
    op.drop_index(op.f('ix_events_aggregate_id'), table_name='events')
    op.drop_table('events')
    op.drop_index(op.f('ix_event_outbox_topic_name'), table_name='event_outbox')
    op.drop_index(op.f('ix_event_outbox_status'), table_name='event_outbox')
    op.drop_index(op.f('ix_event_outbox_next_retry_at'), table_name='event_outbox')
    op.drop_index(op.f('ix_event_outbox_idempotency_key'), table_name='event_outbox')
    op.drop_index(op.f('ix_event_outbox_event_type'), table_name='event_outbox')
    op.drop_index(op.f('ix_event_outbox_created_at'), table_name='event_outbox')
    op.drop_index(op.f('ix_event_outbox_aggregate_type'), table_name='event_outbox')
    op.drop_index(op.f('ix_event_outbox_aggregate_id'), table_name='event_outbox')
    op.drop_table('event_outbox')
    op.drop_table('delivery_terms')
    op.drop_index(op.f('ix_data_retention_policies_data_category'), table_name='data_retention_policies')
    op.drop_table('data_retention_policies')
    op.drop_index(op.f('ix_consent_versions_consent_type'), table_name='consent_versions')
    op.drop_table('consent_versions')
    op.drop_index(op.f('ix_commodities_name'), table_name='commodities')
    op.drop_index(op.f('ix_commodities_hsn_code'), table_name='commodities')
    op.drop_index(op.f('ix_commodities_hs_code_6digit'), table_name='commodities')
    op.drop_index(op.f('ix_commodities_category'), table_name='commodities')
    op.drop_table('commodities')
    op.drop_index(op.f('ix_capabilities_code'), table_name='capabilities')
    op.drop_index(op.f('ix_capabilities_category'), table_name='capabilities')
    op.drop_table('capabilities')
    op.drop_index(op.f('ix_business_partners_tax_id_number'), table_name='business_partners')
    op.drop_index(op.f('ix_business_partners_pan_number'), table_name='business_partners')
    op.drop_index(op.f('ix_business_partners_master_entity_id'), table_name='business_partners')
    op.drop_index(op.f('ix_business_partners_legal_name'), table_name='business_partners')
    op.drop_index(op.f('ix_business_partners_entity_class'), table_name='business_partners')
    op.drop_index(op.f('ix_business_partners_country'), table_name='business_partners')
    op.drop_index(op.f('ix_business_partners_corporate_group_id'), table_name='business_partners')
    op.drop_table('business_partners')
    op.drop_table('bargain_types')
    # ### end Alembic commands ###
    
    # Drop ENUM types
    op.execute('DROP TYPE IF EXISTS notificationstatus CASCADE')
    op.execute('DROP TYPE IF EXISTS notificationpriority CASCADE')
    op.execute('DROP TYPE IF EXISTS notificationtype CASCADE')
    op.execute('DROP TYPE IF EXISTS notificationcategory CASCADE')
    op.execute('DROP TYPE IF EXISTS requeststatus CASCADE')
    op.execute('DROP TYPE IF EXISTS userrighttype CASCADE')
    op.execute('DROP TYPE IF EXISTS outboxstatus CASCADE')
    op.execute('DROP TYPE IF EXISTS datacategory CASCADE')
    op.execute('DROP TYPE IF EXISTS consenttype CASCADE')
